



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="A Material Design theme for MyNotes">
      
      
      
        <meta name="author" content="Anonymous">
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="jp">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>LVSKeepalived - Material Design for MyNotes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="manifest" href="../manifest.webmanifest">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-131093963-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="light-green">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#linux-virtual-server" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Material Design for MyNotes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Material Design for MyNotes
            </span>
            <span class="md-header-nav__topic">
              LVSKeepalived
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/Black-Gold/MyNotes/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Black-Gold/MyNotes
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Material Design for MyNotes" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Material Design for MyNotes
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/Black-Gold/MyNotes/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Black-Gold/MyNotes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Vim/" title="Vim" class="md-nav__link">
      Vim
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      ProgramLanguages
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        ProgramLanguages
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../BREs/" title="BREs" class="md-nav__link">
      BREs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Shell/" title="Shell" class="md-nav__link">
      Shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Python3/" title="Python3" class="md-nav__link">
      Python3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Lua/" title="Lua" class="md-nav__link">
      Lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Go/" title="Go" class="md-nav__link">
      Go
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      AboutLinux
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        AboutLinux
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Utilities/" title="Iproute2&Net-tools" class="md-nav__link">
      Iproute2&Net-tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Iptables/" title="Iptables" class="md-nav__link">
      Iptables
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Firewalld/" title="Firewalld" class="md-nav__link">
      Firewalld
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      DevOps
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        DevOps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Ansible/" title="Ansible" class="md-nav__link">
      Ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Apollo/" title="Apollo" class="md-nav__link">
      Apollo
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      WebServer
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        WebServer
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Nginx/" title="Nginx" class="md-nav__link">
      Nginx
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Apache/" title="Apache&PHP-FPM" class="md-nav__link">
      Apache&PHP-FPM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tomcat/" title="Tomcat" class="md-nav__link">
      Tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../WildFly.md" title="WildFly" class="md-nav__link">
      WildFly
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Caddy/" title="Caddy" class="md-nav__link">
      Caddy
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      OptimisingWebDelivery
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        OptimisingWebDelivery
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Squid/" title="Squid" class="md-nav__link">
      Squid
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Varnish/" title="Varnish" class="md-nav__link">
      Varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Stunnel/" title="Stunnel" class="md-nav__link">
      Stunnel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../TrafficServer/" title="ApacheTrafficServer" class="md-nav__link">
      ApacheTrafficServer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      CI&DC
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        CI&DC
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Git/" title="Git&GitLab" class="md-nav__link">
      Git&GitLab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Jenkins/" title="Jenkins" class="md-nav__link">
      Jenkins
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../MySQL/" title="MySQL" class="md-nav__link">
      MySQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../MariaDB/" title="MariaDB" class="md-nav__link">
      MariaDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Oracle/" title="Oracle" class="md-nav__link">
      Oracle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Redis/" title="Redis" class="md-nav__link">
      Redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Memcached/" title="Memcached" class="md-nav__link">
      Memcached
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../MongoDB/" title="MongoDB" class="md-nav__link">
      MongoDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../PostgreSQL/" title="PostgreSQL" class="md-nav__link">
      PostgreSQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Cassandra/" title="Cassandra" class="md-nav__link">
      Cassandra
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Zabbix/" title="Zabbix" class="md-nav__link">
      Zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Prometheus/" title="Prometheus" class="md-nav__link">
      Prometheus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Grafana/" title="Grafana" class="md-nav__link">
      Grafana
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Elk/" title="ELKStack" class="md-nav__link">
      ELKStack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Nagios/" title="Nagios" class="md-nav__link">
      Nagios
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../TICK/" title="TICKStack" class="md-nav__link">
      TICKStack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../OpenTSDB/" title="OpenTSDB" class="md-nav__link">
      OpenTSDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Monitors/" title="SomelseMonitors" class="md-nav__link">
      SomelseMonitors
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11" checked>
    
    <label class="md-nav__link" for="nav-11">
      LB&HA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        LB&HA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        LVSKeepalived
      </label>
    
    <a href="./" title="LVSKeepalived" class="md-nav__link md-nav__link--active">
      LVSKeepalived
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lvskeepalived" title="LVS+Keepalived解决方案官方示例" class="md-nav__link">
    LVS+Keepalived解决方案官方示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived" title="Keepalived配置文件详解" class="md-nav__link">
    Keepalived配置文件详解
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vrrpd" title="VRRPD配置包含如下子块" class="md-nav__link">
    VRRPD配置包含如下子块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs" title="LVS配置" class="md-nav__link">
    LVS配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived_1" title="修改Keepalived日志" class="md-nav__link">
    修改Keepalived日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs-natkeepalived" title="LVS-NAT+Keepalived主从部署示例" class="md-nav__link">
    LVS-NAT+Keepalived主从部署示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvsip" title="LVS服务器上配置IP" class="md-nav__link">
    LVS服务器上配置IP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvskeepalived_1" title="LVS服务器上分别安装并配置keepalived" class="md-nav__link">
    LVS服务器上分别安装并配置keepalived
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lvskeepalivedconf" title="主LVS配置keepalived.conf" class="md-nav__link">
    主LVS配置keepalived.conf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lvs_1" title="从LVS配置" class="md-nav__link">
    从LVS配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs_notifysh" title="创建通用单独的检查邮件提醒脚本lvs_notify.sh" class="md-nav__link">
    创建通用单独的检查邮件提醒脚本lvs_notify.sh
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Haproxy/" title="HAProxy" class="md-nav__link">
      HAProxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Traefik/" title="Traefik" class="md-nav__link">
      Traefik
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Envoy/" title="Envoy" class="md-nav__link">
      Envoy
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      ContainerEcosystem
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        ContainerEcosystem
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Docker/" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../OKD/" title="OKD" class="md-nav__link">
      OKD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Coreos/" title="ContainerOS" class="md-nav__link">
      ContainerOS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      MessageQueue
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        MessageQueue
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../ActiveMQ/" title="ActiveMQ" class="md-nav__link">
      ActiveMQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ActiveMQApollo/" title="ActiveMQ Apollo" class="md-nav__link">
      ActiveMQ Apollo
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Kafka/" title="Kafka" class="md-nav__link">
      Kafka
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RabbitMQ/" title="RabbitMQ" class="md-nav__link">
      RabbitMQ
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-14" type="checkbox" id="nav-14">
    
    <label class="md-nav__link" for="nav-14">
      FileSystem
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-14">
        FileSystem
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Ceph/" title="Ceph" class="md-nav__link">
      Ceph
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../GlusterFS/" title="GlusterFS" class="md-nav__link">
      GlusterFS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Vsftp/" title="Vsftp" class="md-nav__link">
      Vsftp
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-15" type="checkbox" id="nav-15">
    
    <label class="md-nav__link" for="nav-15">
      Security
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-15">
        Security
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Snort/" title="Snort" class="md-nav__link">
      Snort
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-16" type="checkbox" id="nav-16">
    
    <label class="md-nav__link" for="nav-16">
      Network
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-16">
        Network
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Cisco/" title="Cisco" class="md-nav__link">
      Cisco
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Huawei/" title="Huawei" class="md-nav__link">
      Huawei
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../DNS/" title="DNS" class="md-nav__link">
      DNS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Mail/" title="Mail" class="md-nav__link">
      Mail
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Samba/" title="Samba" class="md-nav__link">
      Samba
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-17" type="checkbox" id="nav-17">
    
    <label class="md-nav__link" for="nav-17">
      CrossGFW
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-17">
        CrossGFW
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../VPN/" title="VPN" class="md-nav__link">
      VPN
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Shadowsocks/" title="Shadowsocks" class="md-nav__link">
      Shadowsocks
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-18" type="checkbox" id="nav-18">
    
    <label class="md-nav__link" for="nav-18">
      TreasureTheLeisure
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-18">
        TreasureTheLeisure
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../GoogleTricks/" title="GoogleTricks" class="md-nav__link">
      GoogleTricks
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Freeswitch/" title="Freeswitch" class="md-nav__link">
      Freeswitch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Asterisk/" title="Asterisk" class="md-nav__link">
      Asterisk
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Sipcode/" title="Sipcode" class="md-nav__link">
      Sipcode
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Raspberrypi/" title="Raspberrypi" class="md-nav__link">
      Raspberrypi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Windows/" title="Windows" class="md-nav__link">
      Windows
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lvskeepalived" title="LVS+Keepalived解决方案官方示例" class="md-nav__link">
    LVS+Keepalived解决方案官方示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived" title="Keepalived配置文件详解" class="md-nav__link">
    Keepalived配置文件详解
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vrrpd" title="VRRPD配置包含如下子块" class="md-nav__link">
    VRRPD配置包含如下子块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs" title="LVS配置" class="md-nav__link">
    LVS配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived_1" title="修改Keepalived日志" class="md-nav__link">
    修改Keepalived日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs-natkeepalived" title="LVS-NAT+Keepalived主从部署示例" class="md-nav__link">
    LVS-NAT+Keepalived主从部署示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvsip" title="LVS服务器上配置IP" class="md-nav__link">
    LVS服务器上配置IP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvskeepalived_1" title="LVS服务器上分别安装并配置keepalived" class="md-nav__link">
    LVS服务器上分别安装并配置keepalived
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lvskeepalivedconf" title="主LVS配置keepalived.conf" class="md-nav__link">
    主LVS配置keepalived.conf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lvs_1" title="从LVS配置" class="md-nav__link">
    从LVS配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs_notifysh" title="创建通用单独的检查邮件提醒脚本lvs_notify.sh" class="md-nav__link">
    创建通用单独的检查邮件提醒脚本lvs_notify.sh
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Black-Gold/MyNotes/edit/master/docs/LVSKeepalived.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="linux-virtual-server">Linux Virtual Server<a class="headerlink" href="#linux-virtual-server" title="Permanent link">&para;</a></h1>
<div class="codehilite"><pre><span></span>Linux虚拟服务器是一个高度可扩展且高度可用的服务器，构建在真实服务器集群上。服务器群集的体系结构对最终用户完全透明，用户与群集系统进行交互，就好像它只是一个高性能的虚拟服务器一样。
</pre></div>

<p><img alt="figure" src="http://www.linuxvirtualserver.org/VirtualServer.png" /></p>
<div class="codehilite"><pre><span></span>真实服务器和负载平衡器可以通过高速LAN或地理上分散的WAN互连。负载均衡器可以将请求分派给不同的服务器，并使群集的并行服务在单个IP地址上显示为虚拟服务，请求分派可以使用IP负载平衡技术或应用级负载均衡技术。通过透明地添加或删除集群中的节点来实现系统的可伸缩性。通过检测节点或守护程序故障并适当地重新配置系统来提供高可用性。
</pre></div>

<div class="codehilite"><pre><span></span>构建服务器集群方法：
DNS负载平衡：
简单，利用域名系统将域名解析到服务器不同的IP来分发请求，DNS服务器根据调度策略(如循环方式)发出服务器IP地址，然后使用相同的本地缓存域名服务器在指定的域名解析生存时间(TTL)中发送到同一个服务器。
但是，由于客户端和分层DNS系统的缓存特性，很容易导致服务器之间的动态负载不平衡，因此服务器不容易处理其峰值负载。在DNS服务器上无法很好地选择名称映射的TTL值，小值DNS流量很高且DNS服务器将成为瓶颈，并且具有高值，动态负载不平衡将变得更糟。即使TTL值设置为零，调度粒度是每个主机，不同用户的访问模式可能会导致动态负载不平衡，因为有些人可能从网站上抽取大量页面，而其他人可能只是浏览几页然后去远。此外，它不太可靠，当服务器节点发生故障时，将名称映射到IP地址的客户端将发现服务器已关闭

基于调度程序的负载平衡群集：
可用于在群集中的服务器之间分配负载，以便服务器的并行服务可以在单个IP地址上显示为虚拟服务，并且最终用户可以像单个服务器一样进行交互不知道集群中的所有服务器。与基于DNS的负载平衡相比，调度程序可以以精细的粒度（例如每个连接）调度请求，以便在服务器之间实现更好的负载平衡。当一台或多台服务器发生故障时，可以屏蔽故障。服务器管理变得越来越容易，管理员可以随时使用服务器或更多服务器，这不会中断最终用户的服务。

负载均衡可以在两个级别完成，即应用级和IP级。将HTTP请求转发到集群中的不同Web服务器，获取结果，然后将其返回给客户端。由于在应用程序级别处理HTTP请求和回复的开销很高，当服务器节点数量增加到5或更多时，应用程序级负载均衡器将成为新的瓶颈，这取决于每个服务器节点的吞吐量服务器
</pre></div>

<div class="codehilite"><pre><span></span>LinuxVirtualServer以三种IP负载均衡技术(数据包转发方法)实现。
1. NAT方式
2. IP隧道
3. 直接路由
</pre></div>

<p>VS/NAT，VS/TUN和VS/DR的比较：
|      对比方面       |   VS/NAT   |  VS/TUN   |   VS/DR    |
| :-----------------: | :--------: | :-------: | :--------: |
|     realserver      |    任何    |   隧道    | 非ARP设备  |
| realserver network  |    私有    |  lan/wan  |    lan     |
| realserver numbers  | low(10-20) |   high    |    high    |
| realserver gateway  |  director  | ownrouter | own router |
| client connnects to |    VIP     |    VIP    |    VIP     |</p>
<p>LVS集群通常采用三连接架构：
<img alt="architecture" src="http://www.linuxvirtualserver.org/lvs_architecture.jpg" /></p>
<p>三连接结构包括：</p>
<p>**负载均衡器**它是整个集群系统的前端机器，并在一组服务器之间平衡来自客户端的请求，以便客户端认为所有服务都来自单个IP地址。</p>
<p>**服务器群集**它是一组运行实际网络服务的服务器，例如Web，邮件，FTP，DNS和媒体服务。</p>
<p>**共享存储**为服务器提供共享存储空间，以便服务器可以轻松拥有相同的内容并提供相同的服务。</p>
<p>NAT:
NAT(Network Address Translation)网络地址转换即将IP地址从一个组映射到另一个组的功能。当地址映射为N到N时，称为静态网络地址转换; 当映射是M到N（M&gt; N）时，它被称为动态网络地址转换。网络地址端口转换是基本NAT的扩展，因为许多网络地址及其TCP/UDP端口被转换为单个网络地址及其TCP/UDP端口。这是N-to-1映射，实现了Linux IP Masquerading(伪装)。Linux上的NAT虚拟服务器是通过网络地址端口转换完成的
<img alt="architecture" src="http://www.linuxvirtualserver.org/VS-NAT.gif" />
当用户访问服务器集群提供的服务时，发往虚拟IP地址的请求数据包（负载均衡器的外部IP地址）到达负载均衡器。负载均衡器检查数据包的目标地址和端口号。如果根据虚拟服务器规则表匹配虚拟服务器服务，则通过调度算法从集群中选择真实服务器，并将连接添加到记录已建立连接的哈希表中。然后，将目标地址和数据包的端口重写为所选服务器的目标地址和端口，并将数据包转发到服务器。当传入数据包属于此连接并且可以在哈希表中找到所选服务器时，将重写该数据包并将其转发到所选服务器。当回复数据包返回时，负载均衡器将数据包的源地址和端口重写为虚拟服务的源地址和端口。连接终止或超时后，连接记录将在哈希表中删除。</p>
<p>IP隧道：
IP隧道（IP封装）是一种将IP数据包封装在IP数据报中的技术，它允许将发往一个IP地址的数据报包装并重定向到另一个IP地址。IP封装现在通常用于外联网，移动IP，IP多播，隧道主机或网络。
<img alt="architecture" src="http://www.linuxvirtualserver.org/VS-IPTunneling.gif" />
当用户访问由服务器集群提供的虚拟服务时，到达虚拟IP地址的分组（虚拟服务器的IP地址）到达。负载均衡器检查数据包的目标地址和端口。如果它们匹配虚拟服务，则根据连接调度算法从群集中选择真实服务器，并将连接添加到记录连接的哈希表中。然后，负载均衡器将数据包封装在IP数据报中，并将其转发到所选服务器。当传入数据包属于此连接并且可以在哈希表中找到所选服务器时，将再次封装数据包并将其转发到该服务器。当服务器收到封装的数据包时，它会解封装数据包并处理请求，最后根据自己的路由表将结果直接返回给用户。连接终止或超时后，连接记录将从哈希表中删除。</p>
<p>直接路由:
此请求调度方法类似于IBM的NetDispatcher中实现的方法。虚拟IP地址由真实服务器和负载均衡器共享。负载均衡器的接口也配置了虚拟IP地址，用于接受请求数据包，并直接将数据包路由到选定的服务器。所有真实服务器的非arp别名接口都配置了虚拟IP地址，或者将发往虚拟IP地址的数据包重定向到本地套接字，以便真实服务器可以在本地处理数据包。负载均衡器和真实服务器必须通过HUB / Switch物理连接其中一个接口。通过直接路由的虚拟服务器的体系结构如下所示：
<img alt="architecture" src="http://www.linuxvirtualserver.org/VS-DRouting.gif" />
当用户访问由服务器集群提供的虚拟服务时，到达虚拟IP地址的分组（虚拟服务器的IP地址）到达。负载均衡器（LinuxDirector）检查数据包的目标地址和端口。如果它们匹配虚拟服务，则通过调度算法从群集中选择真实服务器，并将连接添加到记录连接的哈希表中。然后，负载均衡器直接将其转发到所选服务器。当传入数据包属于此连接并且可以在哈希表中找到所选服务器时，该数据包将再次直接路由到服务器。当服务器收到转发的数据包时，服务器发现该数据包是用于其别名接口上的地址或本地套接字的地址，所以它处理请求并最终将结果直接返回给用户。连接终止或超时后，连接记录将从哈希表中删除。</p>
<p>作业调度算法：
循环调度Round Robin PR
加权循环调度Weighted Round Robin WPR
最小连接调度Least Connections LC
加权最小连接调度Weighted Least Connections WLC
基于位置的最小连接调度Locality-Based Least Connections LBLC
基于位置的最小连接与复制调度Locality-Based Least Connections with Replication LBLCR
目的地哈希调度Destination Hashing DH
源哈希调度Source Hashing SH
最短的预期延迟调度Shortest Expected Delay Scheduling SED
从不排队调度Never Queue Scheduling NQ</p>
<p>循环调度
循环调度算法将每个传入请求发送到其列表中的下一个服务器。因此，在三服务器集群（服务器A，B和C）中，请求1将转到服务器A，请求2将转到服务器B，请求3将转到服务器C，请求4将转到服务器A，从而完成骑自行车或服务器'循环'。无论每个服务器遇到的传入连接数或响应时间如何，它都将所有真实服务器视为相等。与传统的循环DNS相比，Virtual Server具有一些优势。循环DNS将单个域解析为不同的IP地址，调度粒度是基于主机的，并且DNS查询的缓存阻碍了基本算法，这些因素导致真实服务器之间显着的动态负载不平衡。</p>
<p>加权循环调度
加权循环调度旨在更好地处理具有不同处理能力的服务器。可以为每个服务器分配一个权重，一个表示处理能力的整数值。具有较高权重的服务器首先接收新连接，而不是权重较小的服务器，具有较高权重的服务器比具有较少权重的服务器获得更多连接，具有相同权重的服 例如，真实服务器A，B和C分别具有权重4,3,2，在调度周期（mod sum（Wi））中，良好的调度序列将是AABABCABC。在加权循环调度的实现中，在修改虚拟服务器的规则之后，将根据服务器权重生成调度序列。</p>
<p>当真实服务器的处理能力不同时，加权循环调度优于循环调度。但是，如果请求的负载变化很大，则可能导致真实服务器之间的动态负载不平衡。简而言之，大多数需要大响应的请求可能会被引导到同一个真实服务器。</p>
<p>实际上，循环调度是加权循环调度的一个特殊实例，其中所有权重都相等。</p>
<p>最小连接调度
最少连接调度算法将网络连接定向到具有最少数量的已建立连接的服务器。这是动态调度算法之一; 因为它需要动态计算每个服务器的实时连接。对于管理具有类似性能的服务器集合的虚拟服务器，当请求的负载变化很大时，最少连接调度可以平滑分发。虚拟服务器将使用最少的活动连接将请求定向到真实服务器。</p>
<p>乍一看，即使存在各种处理能力的服务器，最少连接调度也可能表现良好，因为更快的服务器将获得更多的网络连接。实际上，由于TCP的TIME_WAIT状态，它无法很好地执行。TCP的TIME_WAIT通常是2分钟，在这2分钟内，一个繁忙的网站经常收到数千个连接，例如，服务器A的功能是服务器B的两倍，服务器A处理数千个请求并将它们保存在TCP的TIME_WAIT状态，但服务器B正在爬行以完成其数千个连接。因此，最少连接调度不能在具有各种处理能力的服务器之间很好地平衡负载。</p>
<p>加权最小连接调度
加权最小连接调度是最小连接调度的超集，您可以在其中为每个真实服务器分配性能权重。具有较高权重值的服务器在任何时候都将获得更大比例的实时连接。虚拟服务器管理员可以为每个真实服务器分配权重，并且将网络连接安排到每个服务器，其中每个服务器的当前活动连接数的百分比是与其权重的比率。默认权重为1。</p>
<p>加权最小连接调度的工作原理如下：
假设有n个真实服务器，每个服务器i的权重为W i（i = 1，..，n），而活动连接C i （i = 1，..，n），ALL_CONNECTIONS是C i的总和 （i = 1，..，n），下一个网络连接将被定向到服务器j，其中
（C j / ALL_CONNECTIONS）/ W j = min {（C i / ALL_CONNECTIONS）/ W i }（i = 1，..，n）
由于ALL_CONNECTIONS在此查找中是常量，因此无需将C i除以ALL_CONNECTIONS，它可以优化为
C j / W j = min {C i / W i }（i = 1，..，n）
加权最小连接调度算法需要比最小连接更多的划分。为了在服务器具有相同的处理能力时最小化调度的开销，实现最少连接调度和加权最小连接调度算法。</p>
<p>基于位置的最小连接调度
基于位置的最小连接调度算法用于目标IP负载平衡。它通常用于缓存集群。如果服务器处于活动状态且负载不足，此算法通常会将发往IP地址的数据包定向到其服务器。如果服务器过载（其活动连接数大于其权重）并且服务器处于半负载状态，则将加权最小连接服务器分配给此IP地址。</p>
<p>基于位置的最小连接与复制调度
基于位置的最小连接与复制调度算法也用于目标IP负载平衡。它通常用于缓存集群。它与LBLC调度的不同之处如下：负载均衡器维护从目标到可以为目标服务的一组服务器节点的映射。对目标的请求将分配给目标服务器集中的最小连接节点。如果服务器集中的所有节点都过载，它将在集群中获取最少连接节点，并将其添加到目标服务器集中。如果服务器集未在指定时间内进行修改，则会从服务器集中删除负载最多的节点，以避免高度复制。</p>
<p>目的地哈希调度
目标哈希调度算法通过按目标IP地址查找静态分配的哈希表来为服务器分配网络连接。</p>
<p>源哈希调度
源哈希调度算法通过按源IP地址查找静态分配的哈希表来为服务器分配网络连接。</p>
<p>最短的预期延迟调度
最短的预期延迟调度算法以最短的预期延迟将网络连接分配给服务器。如果发送到第i个服务器，作业将经历的预期延迟是（Ci + 1）/ Ui，其中Ci是第i个服务器上的连接数，Ui是第i个服务器的固定服务速率（权重） 。</p>
<p>从不排队调度
永不排队调度算法采用双速模型。当有空闲服务器可用时，作业将被发送到空闲服务器，而不是等待快速服务器。当没有可用的空闲服务器时，作业将被发送到服务器，以最小化其预期延迟（最短预期延迟调度算法）。</p>
<p>LVS中IP或网络的名称</p>
<div class="codehilite"><pre><span></span>典型的LVS-NAT设置：LVS-NAT: no arp problem (the realservers don&#39;t have the VIP)
                        ________
                       |        |
                       | client | (local or on internet)
                       |________|
                          CIP
                           |
                        (router)
                          DGW--DIRECTOR-gateway
                           | outside network
                           |
                          VIP--Virtual IP
                       ____|_____
                      |          | (director can have 1 or 2 NICs)
                      | director |
                      |__________|
                      DIP (and PIP)--primary director IP = PIP (the director which will be the master on bootup)
                           |       --secondary director IP = SIP (the director which will be the backup on bootup)
                           | DRIP network
          ----------------------------------
          |                |               |
          |                |               |
         RIP1             RIP2            RIP3
     _____________   _____________   _____________
    |             | |             | |             |
    | realserver1 | | realserver2 | | realserver3 |
    |_____________| |_____________| |_____________|

典型的LVS-DR or LVS-Tun设置
                        ________
                       |        |
                       | client | (local or on internet)
                       |________|
                           |
                        (router)-----------
                           |    SERVER_GW  |
                           |               |
                          VIP              |
                       ____|_____          |
                      |          | (director can have 1 or 2 NICs)
                      | director |         |
                      |__________|         |
                          DIP              |
                           |               |
                           |               |
          -----------------+----------------
          |                |               |
          |                |               |
       RIP1,VIP         RIP2,VIP        RIP3,VIP
    ____________     ____________     ____________
   |            |   |            |   |            |
   | realserver |   | realserver |   | realserver |
   |____________|   |____________|   |____________|

client IP     = CIP
virtual IP    = VIP - the IP on the director that the client connects to)
director IP   = DIP - the IP on the director in the DIP/RIP (DRIP) network
   (this is the realserver gateway for LVS-NAT)
realserver IP = RIP (and RIP1, RIP2...) the IP on the realserver
director GW   = DGW - the director&#39;s gw (only needed for LVS-NAT)
   (this can be the realserver gateway for LVS-DR and LVS-Tun)

VIP和DIP设置为辅助IP（即该NIC(网卡)上有另一个主IP），因此可以在director故障转移后将它们移动到另一个复制的director。对于使用单个director的初始设置，将VIP和DIP设置为次要IP将使故障转移设置更加容易。
</pre></div>

<table>
<thead>
<tr>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">DGW</td>
<td align="center">公网IP的默认网关</td>
</tr>
<tr>
<td align="center">VIP</td>
<td align="center">客户端访问的公网IP，Director的虚拟IP</td>
</tr>
<tr>
<td align="center">DIP</td>
<td align="center">Director的真实IP</td>
</tr>
<tr>
<td align="center">RIP</td>
<td align="center">realserver的IP</td>
</tr>
<tr>
<td align="center">RIP</td>
<td align="center">客户端IP</td>
</tr>
</tbody>
</table>
<p>例子：LVS使用LVS-NAT转发</p>
<div class="codehilite"><pre><span></span>在direcotor使用一个网卡，也可使用两个，但要改变设置。
                      ________
                     |        |
                     | client |
                     |________|
                  CIP=DGW=192.168.2.254 (eth0)
                         |
                         |
           __________    |
          |          |   |   (VIP=192.168.2.110,eth0:110)
          | director |---|
          |__________|   |   DIP=SGW=192.168.1.9(eth0)
                         |
                         |
        -----------------------------------
        |                                 |
        |                                 |
RIP=192.168.1.11(eth0)              RIP=192.168.1.12(eth0)
   ____________                        ____________
  |            |                      |            |
  | realserver |                      | realserver |
  |____________|                      |____________|
</pre></div>

<p>例子：LVS使用LVS-DR转发</p>
<div class="codehilite"><pre><span></span>在具有单个NIC的计算机上使用单个网络（此处为192.168.1.0/24）设置LVS。以太网别名上的IP（例如eth0：110，lo：0）由configure脚本设置。没有默认路由，并且所有计算机都应该能够相互ping通。
                        ________
                       |        |
                       | client |
                       |________|
                   CIP=SGW=192.168.1.254 (eth0)
                           |
                           |
             __________    |
            |          |   |   (VIP=192.168.1.110, eth0:110)
            | director |---|
            |__________|   |   DIP=192.168.1.9 (eth0)
                           |
                           |
          -----------------------------------
          |                                 |
          |                                 |
 RIP=192.168.1.11(eth0)             RIP=192.168.1.12(eth0)
(VIP=192.168.1.110, lo:0)          (VIP=192.168.1.110, lo:0)
    ____________                       ____________
   |            |                     |            |
   | realserver |                     | realserver |
   |____________|                     |____________|
</pre></div>

<h2 id="lvskeepalived">LVS+Keepalived解决方案官方示例<a class="headerlink" href="#lvskeepalived" title="Permanent link">&para;</a></h2>
<p>使用keepalived构建一个具有两个负载平衡器和三个Web服务器的高可用性VS/NAT Web集群，拓扑图如下：
<img alt="topology" src="http://linux-vs.org/docs/ha/keepalived.jpg" />
在本例中，VIP地址和DIP地址分别为10.23.8.80和172.18.1.254均为浮动IP，它们在两个负载均衡器（LD1和LD2）之间浮动，三个realserver的IP地址为172.18.1.11,172.18.1.12和172.18.1.13。
float IP工作原理如下图：
<img alt="yuanlli" src="http://assets.digitalocean.com/blog/static/floating-ips-start-architecting-your-applications-for-high-availability/ha-diagram-animated.gif" />
LD1上的keepalived配置文件（/etc/keepalived/keepalived.conf）如下:</p>
<div class="codehilite"><pre><span></span>vrrp_sync_group VG1 {
    group {
        VI_1
        VI_2
    }
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.23.8.80
    }
}

vrrp_instance VI_2 {
    state MASTER
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        172.18.1.254
    }
}

virtual_server 10.23.8.80 80 {
    delay_loop 6
    lb_algo wlc
    lb_kind NAT
    persistence_timeout 600
    protocol TCP

    real_server 172.18.1.11 80 {
        weight 100
        TCP_CHECK {
            connect_timeout 3
        }
    }
    real_server 172.18.1.12 80 {
        weight 100
        TCP_CHECK {
            connect_timeout 3
        }
    }
    real_server 172.18.1.13 80 {
        weight 100
        TCP_CHECK {
            connect_timeout 3
        }
    }
}
LD2的和LD1相似，只需将VI_1和VI_2的状态从master改为backup
</pre></div>

<h2 id="keepalived">Keepalived配置文件详解<a class="headerlink" href="#keepalived" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="c1"># 全局定义模块</span>
<span class="n">global_defs</span> <span class="p">{</span>
   <span class="n">notification_email</span> <span class="p">{</span>
     <span class="n">acassen</span><span class="o">@</span><span class="n">firewall.loc</span>
     <span class="n">failover</span><span class="o">@</span><span class="n">firewall.loc</span>
     <span class="n">sysadmin</span><span class="o">@</span><span class="n">firewall.loc</span> <span class="c1">#邮件报警</span>
   <span class="p">}</span>
   <span class="n">notification_email_from</span> <span class="n">Alexandre.Cassen</span><span class="o">@</span><span class="n">firewall.loc</span> 指定发件人
   <span class="n">smtp_server</span> <span class="m">192.168.200.1</span>  <span class="c1">#指定smtp服务器地址</span>
   <span class="n">smtp_connect_timeout</span> <span class="m">30</span>    指定<span class="n">smtp连接超时时间</span>
   <span class="n">router_id</span> <span class="n">LVS_DEVEL</span>  <span class="c1">#负载均衡标识，在局域网内应该是唯一的。</span>
   <span class="n">vrrp_skip_check_adv_addr</span>
   <span class="n">vrrp_strict</span>
   <span class="n">vrrp_garp_interval</span> <span class="m">0</span>
   <span class="n">vrrp_gna_interval</span> <span class="m">0</span>
<span class="p">}</span>

说明：
<span class="n">notification_email</span>：指定当<span class="n">keepalived出现问题时</span>，发送邮件给哪些用户。
<span class="n">notification_emai_from</span>：发送邮件时，邮件的来源地址。
<span class="n">smtp_server</span> <span class="o">&lt;</span><span class="n">DOMAIN</span><span class="o">|</span><span class="n">IP</span><span class="o">&gt;</span> <span class="n">[</span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="n">]</span>：<span class="n">smtp服务器的地址或域名</span>。默认端口为<span class="m">25</span><span class="n">.如</span>：<span class="n">smtp_server</span> <span class="n">smtp.felix.com</span> <span class="m">25</span>
<span class="n">smtp_helo_name</span> <span class="o">&lt;</span><span class="n">HOST_NAME</span><span class="o">&gt;</span>：指定在<span class="n">HELO消息中所使用的名称</span>。默认为本地主机名。
<span class="n">smtp_connect_timeout</span>：指定<span class="n">smtp服务器连接的超时时间</span>。单位是秒。

<span class="n">router_id</span>：指定标识该机器的<span class="n">route_id.</span> 如：<span class="n">route_id</span> <span class="n">LVS_01</span>
<span class="n">vrrp_mcast_group4</span> <span class="m">224.0.0.18</span>：指定发送<span class="n">VRRP组播消息使用的IPV4组播地址</span>。默认是<span class="m">224.0.0.18</span>
<span class="n">vrrp_mcast_group6</span> <span class="n">ff02</span><span class="o">::</span><span class="m">12</span> 指定发送<span class="n">VRRP组播消息所使用的IPV6组播地址</span>。默认是<span class="n">ff02</span><span class="o">::</span><span class="m">12</span>
<span class="n">default_interface</span> <span class="n">eth0</span>：设置静态地址默认绑定的端口。默认是<span class="n">eth0</span>。
<span class="n">lvs_sync_daemon</span> <span class="o">&lt;</span><span class="n">INTERFACE</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">VRRP_INSTANCE</span><span class="o">&gt;</span> <span class="n">[id</span> <span class="o">&lt;</span><span class="n">SYNC_ID</span><span class="o">&gt;</span><span class="n">]</span> <span class="n">[maxlen</span> <span class="o">&lt;</span><span class="n">LEN</span><span class="o">&gt;</span><span class="n">]</span> <span class="n">[port</span> <span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="n">]</span> <span class="n">[ttl</span> <span class="o">&lt;</span><span class="n">TTL</span><span class="o">&gt;</span><span class="n">]</span> <span class="n">[group</span> <span class="o">&lt;</span><span class="n">IP</span> <span class="n">ADDR</span><span class="o">&gt;</span><span class="n">]</span>
    设置<span class="n">LVS同步服务的相关内容</span>。可以同步<span class="n">LVS的状态信息</span>。
    <span class="n">INTERFACE</span>：指定同步服务绑定的接口。
    <span class="n">VRRP_INSTANCE</span>：指定同步服务绑定的<span class="n">VRRP实例</span>。
    <span class="n">id</span> <span class="o">&lt;</span><span class="n">SYNC_ID</span><span class="o">&gt;</span>：指定同步服务所使用的<span class="n">SYNCID</span>，只有相同的<span class="n">SYNCID才会同步</span>。范围是<span class="m">0-255</span><span class="n">.</span>
    <span class="n">maxlen</span>：指定数据包的最大长度。范围是<span class="m">1-65507</span>
    <span class="n">port</span>：指定同步所使用的<span class="n">UDP端口</span>。
    <span class="n">group</span>：指定组播<span class="n">IP地址</span>。

<span class="n">lvs_flush</span>：在<span class="n">keepalived启动时</span>，刷新所有已经存在的<span class="n">LVS配置</span>。
<span class="n">vrrp_garp_master_delay</span> <span class="m">10</span>：当转换为<span class="n">MASTER状态时</span>，延迟多少秒发送第二组的免费<span class="n">ARP</span>。默认为<span class="m">5</span><span class="n">s</span>，<span class="m">0</span>表示不发送第二组免的免费<span class="n">ARP</span>。
<span class="n">vrrp_garp_master_repeat</span> <span class="m">1</span>：当转换为<span class="n">MASTER状态时</span>，在一组中一次发送的免费<span class="n">ARP数量</span>。默认是<span class="m">5</span><span class="n">.</span>
<span class="n">vrrp_garp_lower_prio_delay</span> <span class="m">10</span>：当<span class="n">MASTER收到更低优先级的通告时</span>，延迟多少秒发送第二组的免费<span class="n">ARP</span>。
<span class="n">vrrp_garp_lower_prio_repeat</span> <span class="m">1</span>：当<span class="n">MASTER收到更低优先级的通告时</span>，在一组中一次发送的免费<span class="n">ARP数量</span>。
<span class="n">vrrp_garp_master_refresh</span> <span class="m">60</span>：当<span class="n">keepalived成为MASTER以后</span>，刷新免费<span class="nf">ARP的最小时间间隔</span><span class="p">(</span>会再次发送免费<span class="n">ARP</span><span class="p">)</span>。默认是<span class="m">0</span>，表示不会刷新。
<span class="n">vrrp_garp_master_refresh_repeat</span> <span class="m">2</span>： 当<span class="n">keepalived成为MASTER以后</span>，每次刷新会发送多少个免费<span class="n">ARP</span>。默认是<span class="m">1</span><span class="n">.</span>
<span class="n">vrrp_garp_interval</span> <span class="m">0.001</span>：在一个接口发送的两个免费<span class="n">ARP之间的延迟</span>。可以精确到毫秒级。默认是<span class="m">0</span><span class="n">.</span>
<span class="n">vrrp_lower_prio_no_advert</span> <span class="n">true</span><span class="o">|</span><span class="n">false</span>：默认是<span class="n">false</span>。如果收到低优先级的通告，不发送任何通告。
<span class="n">vrrp_version</span> <span class="m">2</span><span class="o">|</span><span class="m">3</span>：设置默认的<span class="n">VRRP版本</span>。默认是<span class="m">2</span><span class="n">.</span>
<span class="n">vrrp_check_unicast_src</span>：在单播模式中，开启对<span class="n">VRRP数据包的源地址做检查</span>，源地址必须是单播邻居之一。
<span class="n">vrrp_skip_check_adv_addr</span>：默认是不跳过检查。检查收到的<span class="n">VRRP通告中的所有地址可能会比较耗时</span>，设置此命令的意思是，如果通告与接收的上一个通告来自相同的<span class="n">master路由器</span>，则不执行检查<span class="p">(</span>跳过检查<span class="p">)</span>。
<span class="n">vrrp_strict</span>：严格遵守<span class="n">VRRP协议</span>。下列情况将会阻止启动<span class="n">Keepalived</span>：<span class="m">1</span><span class="n">. 没有VIP地址</span>。<span class="m">2</span><span class="n">. 单播邻居</span>。<span class="m">3</span><span class="n">. 在VRRP版本2中有IPv6地址</span>。

<span class="n">vrrp_iptables</span>：不添加任何<span class="n">iptables规则</span>。默认是添加<span class="n">iptables规则的</span>。

如果<span class="n">vrrp进程或check进程超时</span>，可以用下面的<span class="m">4</span>个选项。可以使处于<span class="n">BACKUP状态的VRRP实例变成MASTER状态</span>，即使<span class="n">MASTER实例依然在运行</span>。因为<span class="n">MASTER或BACKUP系统比较慢</span>，不能及时处理<span class="n">VRRP数据包</span>。
<span class="n">vrrp_priority</span> <span class="o">&lt;-</span><span class="m">20</span> <span class="o">--</span> <span class="m">19</span><span class="o">&gt;</span>：设置<span class="n">VRRP进程的优先级</span>。
<span class="n">checker_priority</span> <span class="o">&lt;-</span><span class="m">20</span> <span class="o">--</span> <span class="m">19</span><span class="o">&gt;</span>：设置<span class="n">checker进程的优先级</span>。
<span class="n">vrrp_no_swap</span>：<span class="n">vrrp进程不能够被交换</span>。
<span class="n">checker_no_swap</span>：<span class="n">checker进程不能够被交换</span>。

<span class="n">script_user</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span> <span class="n">[groupname]</span>：设置运行脚本默认用户和组。如果没有指定，则默认用户为<span class="nf">keepalived_script</span><span class="p">(</span>需要该用户存在<span class="p">)</span>，否则为<span class="n">root用户</span>。默认<span class="n">groupname同username</span>。
<span class="n">enable_script_security</span>：如果脚本路径的任一部分对于非<span class="n">root用户来说</span>，都具有可写权限，则不会以<span class="n">root身份运行脚本</span>。
<span class="n">nopreempt</span> 默认是抢占模式 要是用非抢占式的就加上<span class="n">nopreempt</span>
注意：上述为<span class="n">global_defs中的指令</span>
</pre></div>

<h2 id="vrrpd">VRRPD配置包含如下子块<a class="headerlink" href="#vrrpd" title="Permanent link">&para;</a></h2>
<ol>
<li>vrrp_script</li>
<li>vrrp_sync_group</li>
<li>vrrp_instance</li>
</ol>
<div class="codehilite"><pre><span></span>作用：添加一个周期性执行的脚本。脚本的退出状态码会被调用它的所有的<span class="n">VRRP</span> <span class="n">Instance记录</span>。
注意：至少有一个<span class="n">VRRP实例调用它并且优先级不能为0.优先级范围是1</span><span class="m">-254</span><span class="n">.</span>
<span class="n">vrrp_script</span> <span class="o">&lt;</span><span class="n">SCRIPT_NAME</span><span class="o">&gt;</span> <span class="p">{</span>
          <span class="kc">...</span>
    <span class="p">}</span>

选项说明：
<span class="n">scrip</span> <span class="s">&quot;/path/to/somewhere&quot;</span>：指定要执行的脚本的路径。
<span class="n">interval</span> <span class="o">&lt;</span><span class="n">INTEGER</span><span class="o">&gt;</span>：指定脚本执行的间隔。单位是秒。默认为<span class="m">1</span><span class="n">s</span>。
<span class="n">timeout</span> <span class="o">&lt;</span><span class="n">INTEGER</span><span class="o">&gt;</span>：指定在多少秒后，脚本被认为执行失败。
<span class="n">weight</span> <span class="o">&lt;-</span><span class="m">254</span> <span class="o">---</span> <span class="m">254</span><span class="o">&gt;</span>：调整优先级。默认为<span class="m">2</span><span class="n">.</span>
<span class="n">rise</span> <span class="o">&lt;</span><span class="n">INTEGER</span><span class="o">&gt;</span>：执行成功多少次才认为是成功。
<span class="n">fall</span> <span class="o">&lt;</span><span class="n">INTEGER</span><span class="o">&gt;</span>：执行失败多少次才认为失败。
<span class="n">user</span> <span class="o">&lt;</span><span class="n">USERNAME</span><span class="o">&gt;</span> <span class="n">[GROUPNAME]</span>：运行脚本的用户和组。
<span class="n">init_fail</span>：假设脚本初始状态是失败状态。

解释：
<span class="n">weight</span>：
<span class="m">1</span><span class="nf">. 如果脚本执行成功</span><span class="p">(</span>退出状态码为<span class="m">0</span><span class="p">)</span>，<span class="n">weight大于0</span>，则<span class="n">priority增加</span>。
<span class="m">2</span><span class="nf">. 如果脚本执行失败</span><span class="p">(</span>退出状态码为非<span class="m">0</span><span class="p">)</span>，<span class="n">weight小于0</span>，则<span class="n">priority减少</span>。
<span class="m">3</span><span class="n">. 其他情况下</span>，<span class="n">priority不变</span>。
</pre></div>

<div class="codehilite"><pre><span></span>作用：将所有相关的VRRP实例定义在一起，作为一个VRRP Group，如果组内的任意一个实例出现问题，都可以实现Failover。
 vrrp_sync_group VG_1 {
    group {
     inside_network     # vrrp instance name
     outside_network    # vrrp instance name
     ...
    }
    ...
}

说明：
如果username和groupname没有指定，则以默认的script_user所指定的用户和组。
1. notify_master /path/to_master.sh [username [groupname]]
    作用：当成为MASTER时，以指定的用户和组执行脚本。
2. notify_backup /path/to_backup.sh [username [groupname]]
    作用：当成为BACKUP时，以指定的用户和组执行脚本。
3. notify_fault &quot;/path/fault.sh VG_1&quot; [username [groupname]]
    作用：当该同步组Fault时，以指定的用户和组执行脚本。
4. notify /path/notify.sh [username [groupname]]
    作用：在任何状态都会以指定的用户和组执行脚本。
    说明：该脚本会在notify_*脚本后执行。
    notify可以使用3个参数，如下：
    $1：可以是GROUP或INTANCE，表明后面是组还是实例。
    $2：组名或实例名。
    $3：转换后的目标状态。有：MASTER、BACKUP、FAULT。

5. smtp_alert：当状态发生改变时，发送邮件。
6. global_tracking：所有的VRRP实例共享相同的tracking配置。

注意：脚本文件要加上x权限，同时指令最好写绝对路径。
</pre></div>

<div class="codehilite"><pre><span></span><span class="err">命令说明：</span>
<span class="nx">state</span> <span class="nx">MASTER</span><span class="o">|</span><span class="nx">BACKUP</span><span class="err">：指定该</span><span class="nx">keepalived节点的初始状态</span><span class="err">。</span>
<span class="kr">interface</span> <span class="nx">eth0</span><span class="err">：</span><span class="nx">vrrp实例绑定的接口</span><span class="err">，用于发送</span><span class="nx">VRRP包</span><span class="err">。</span>
<span class="nx">use_vmac</span> <span class="p">[</span><span class="o">&lt;</span><span class="nx">VMAC_INTERFACE</span><span class="o">&gt;</span><span class="p">]</span><span class="err">：在指定的接口产生一个子接口，如</span><span class="nx">vrrp</span><span class="p">.</span><span class="mi">51</span><span class="err">，该接口的</span><span class="nx">MAC地址为组播地址</span><span class="err">，通过该接口向外发送和接收</span><span class="nx">VRRP包</span><span class="err">。</span>
<span class="nx">vmac_xmit_base</span><span class="err">：通过基本接口向外发送和接收</span><span class="nx">VRRP数据包</span><span class="err">，而不是通过</span><span class="nx">VMAC接口</span><span class="err">。</span>
<span class="nx">native_ipv6</span><span class="err">：强制</span><span class="nx">VRRP实例使用IPV6</span><span class="p">.(</span><span class="err">当同时配置了</span><span class="nx">IPV4和IPV6的时候</span><span class="p">)</span>
<span class="nx">dont_track_primary</span><span class="err">：忽略</span><span class="nx">VRRP接口的错误</span><span class="err">，默认是没有配置的。</span>

<span class="nx">track_interface</span> <span class="p">{</span>
  <span class="nx">eth0</span>
  <span class="nx">eth1</span> <span class="nx">weight</span> <span class="o">&lt;-</span><span class="mi">254</span><span class="o">-</span><span class="mi">254</span><span class="o">&gt;</span>
  <span class="p">...</span>
<span class="p">}</span><span class="err">：如果</span><span class="nx">track的接口有任何一个出现故障</span><span class="err">，都会进入</span><span class="nx">FAULT状态</span><span class="err">。</span>

<span class="nx">track_script</span> <span class="p">{</span>
  <span class="o">&lt;</span><span class="nx">SCRIPT_NAME</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nx">SCRIPT_NAME</span><span class="o">&gt;</span> <span class="nx">weight</span> <span class="o">&lt;-</span><span class="mi">254</span><span class="o">-</span><span class="mi">254</span><span class="o">&gt;</span>
<span class="p">}</span><span class="err">：添加一个</span><span class="nx">track脚本</span><span class="p">(</span><span class="nx">vrrp_script配置的脚本</span><span class="err">。</span><span class="p">)</span>

<span class="nx">mcast_src_ip</span> <span class="o">&lt;</span><span class="nx">IPADDR</span><span class="o">&gt;</span><span class="err">：指定发送组播数据包的源</span><span class="nx">IP地址</span><span class="err">。默认是绑定</span><span class="nx">VRRP实例的接口的主IP地址</span><span class="err">。</span>
<span class="nx">unicast_src_ip</span> <span class="o">&lt;</span><span class="nx">IPADDR</span><span class="o">&gt;</span><span class="err">：指定发送单薄数据包的源</span><span class="nx">IP地址</span><span class="err">。默认是绑定</span><span class="nx">VRRP实例的接口的主IP地址</span><span class="err">。</span>
<span class="nx">version</span> <span class="mi">2</span><span class="o">|</span><span class="mi">3</span><span class="err">：指定该实例所使用的</span><span class="nx">VRRP版本</span><span class="err">。</span>

<span class="nx">unicast_peer</span> <span class="p">{</span>
   <span class="o">&lt;</span><span class="nx">IPADDR</span><span class="o">&gt;</span>
   <span class="p">...</span>
<span class="p">}</span><span class="err">：采用单播的方式发送</span><span class="nx">VRRP通告</span><span class="err">，指定单播邻居的</span><span class="nx">IP地址</span><span class="err">。</span>

<span class="nx">virtual_router_id</span> <span class="mi">51</span><span class="err">：指定</span><span class="nx">VRRP实例ID</span><span class="err">，范围是</span><span class="mi">0</span><span class="o">-</span><span class="mi">255</span><span class="p">.</span>
<span class="nx">priority</span> <span class="mi">100</span><span class="err">：指定优先级，优先级高的将成为</span><span class="nx">MASTER</span><span class="err">。</span>
<span class="nx">advert_int</span> <span class="mi">1</span><span class="err">：指定发送</span><span class="nx">VRRP通告的间隔</span><span class="err">。单位是秒。</span>
<span class="nx">authentication</span> <span class="p">{</span>
  <span class="nx">auth_type</span> <span class="nx">PASS</span><span class="o">|</span><span class="nx">AH</span><span class="err">：指定认证方式。</span><span class="nx">PASS简单密码认证</span><span class="p">(</span><span class="err">推荐</span><span class="p">),</span><span class="nx">AH</span>:<span class="kt">IPSEC认证</span><span class="p">(</span><span class="err">不推荐</span><span class="p">)</span><span class="err">。</span>
  <span class="nx">auth_pass</span> <span class="mi">1234</span><span class="err">：指定认证所使用的密码。最多</span><span class="mi">8</span><span class="err">位。</span>
<span class="p">}</span>

<span class="nx">virtual_ipaddress</span> <span class="p">{</span>
   <span class="o">&lt;</span><span class="nx">IPADDR</span><span class="o">&gt;</span><span class="err">/&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; label &lt;LABEL&gt;</span>
   <span class="mf">192.168</span><span class="p">.</span><span class="mf">200.17</span><span class="o">/</span><span class="mi">24</span> <span class="nx">dev</span> <span class="nx">eth1</span>
   <span class="mf">192.168</span><span class="p">.</span><span class="mf">200.18</span><span class="o">/</span><span class="mi">24</span> <span class="nx">dev</span> <span class="nx">eth2</span> <span class="nx">label</span> <span class="nx">eth2</span>:<span class="kt">1</span>
<span class="p">}</span><span class="err">：指定</span><span class="nx">VIP地址</span><span class="err">。</span>

<span class="nx">nopreempt</span><span class="err">：设置为不抢占。默认是抢占的，当高优先级的机器恢复后，会抢占低优先级的机器成为</span><span class="nx">MASTER</span><span class="err">，而不抢占，则允许低优先级的机器继续成为</span><span class="nx">MASTER</span><span class="err">，即使高优先级的机器已经上线。如果要使用这个功能，则初始化状态必须为</span><span class="nx">BACKUP</span><span class="err">。</span>
<span class="nx">preempt_delay</span><span class="err">：设置抢占延迟。单位是秒，范围是</span><span class="mi">0</span><span class="o">---</span><span class="mi">1000</span><span class="err">，默认是</span><span class="mi">0</span><span class="p">.</span><span class="err">发现低优先级的</span><span class="nx">MASTER后多少秒开始抢占</span><span class="err">。</span>


<span class="err">通知脚本：</span>
<span class="nx">notify_master</span> <span class="o">&lt;</span><span class="nx">STRING</span><span class="o">&gt;|&lt;</span><span class="nx">QUOTED</span><span class="o">-</span><span class="nx">STRING</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">username</span> <span class="p">[</span><span class="nx">groupname</span><span class="p">]]</span>
<span class="nx">notify_backup</span> <span class="o">&lt;</span><span class="nx">STRING</span><span class="o">&gt;|&lt;</span><span class="nx">QUOTED</span><span class="o">-</span><span class="nx">STRING</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">username</span> <span class="p">[</span><span class="nx">groupname</span><span class="p">]]</span>
<span class="nx">notify_fault</span> <span class="o">&lt;</span><span class="nx">STRING</span><span class="o">&gt;|&lt;</span><span class="nx">QUOTED</span><span class="o">-</span><span class="nx">STRING</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">username</span> <span class="p">[</span><span class="nx">groupname</span><span class="p">]]</span>
<span class="nx">notify</span> <span class="o">&lt;</span><span class="nx">STRING</span><span class="o">&gt;|&lt;</span><span class="nx">QUOTED</span><span class="o">-</span><span class="nx">STRING</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">username</span> <span class="p">[</span><span class="nx">groupname</span><span class="p">]]</span>

<span class="err">#</span> <span class="err">当停止</span><span class="nx">VRRP时执行的脚本</span><span class="err">。</span>
<span class="nx">notify_stop</span> <span class="o">&lt;</span><span class="nx">STRING</span><span class="o">&gt;|&lt;</span><span class="nx">QUOTED</span><span class="o">-</span><span class="nx">STRING</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">username</span> <span class="p">[</span><span class="nx">groupname</span><span class="p">]]</span>
<span class="nx">smtp_alert</span>
</pre></div>

<h2 id="lvs">LVS配置<a class="headerlink" href="#lvs" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>virtual_server IP Port | virtual_server fwmark int | virtual_server group string {
  delay_loop &lt;INT&gt;：健康检查的时间间隔。
  lb_argo rr|wrr|lc|wlc|lblc|sh|dh：LVS调度算法。
  lb_kind NAT|DR|TUN：LVS模式。
  persistence_timeout 360：持久化超时时间，单位是秒。默认是6分钟。
  persistence_granularity：持久化连接的颗粒度。
  protocol TCP|UDP|SCTP：4层协议。
  ha_suspend：如果virtual server的IP地址没有设置，则不进行后端服务器的健康检查。
  virtualhost &lt;STRING&gt;：为HTTP_GET和SSL_GET执行要检查的虚拟主机。如virtualhost www.felix.com
  sorry_server &lt;IPADDR&gt; &lt;PORT&gt;：添加一个备用服务器。当所有的RS都故障时。
  sorry_server_inhibit：将inhibit_on_failure指令应用于sorry_server指令。

  alpha：在keepalived启动时，假设所有的RS都是down，以及健康检查是失败的。有助于防止启动时的误报。默认是禁用的。
  omega：在keepalived终止时，会执行quorum_down指令所定义的脚本。

  quorum &lt;INT&gt;：默认值1. 所有的存活的服务器的总的最小权重。
  quorum_up &lt;STRING&gt;：当quorum增长到满足quorum所定义的值时，执行该脚本。
  quorum_down &lt;STRING&gt;：当quorum减少到不满足quorum所定义的值时，执行该脚本。
}
</pre></div>

<div class="codehilite"><pre><span></span>real_server IP Port {
  weight &lt;INT&gt;：给服务器指定权重。默认是1.
  inhibit_on_failure：当服务器健康检查失败时，将其weight设置为0，而不是从Virtual Server中移除。
  notify_up &lt;STRING&gt;：当服务器健康检查成功时，执行的脚本。
  notify_down &lt;STRING&gt;：当服务器健康检查失败时，执行的脚本。
  uthreshold &lt;INT&gt;：到这台服务器的最大连接数。
  lthreshold &lt;INT&gt;：到这台服务器的最小连接数。
}

# real_server中的健康检查
HTTP_GET | SSL_GET {
url {
  path &lt;STRING&gt;：指定要检查的URL的路径。如path / or path /mrtg2
  digest &lt;STRING&gt;：摘要。计算方式：genhash -s 172.17.100.1 -p 80 -u /index.html
  status_code &lt;INT&gt;：状态码。
}
nb_get_retry &lt;INT&gt;：get尝试次数。
delay_before_retry &lt;INT&gt;：在尝试之前延迟多长时间。

connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。
connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。
bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。
bind_port &lt;PORT&gt;：发起连接的源端口。
connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。
fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。
}

TCP_CHECK {
connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。
connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。
bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。
bind_port &lt;PORT&gt;：发起连接的源端口。
connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。
fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。
retry &lt;INIT&gt;：重试次数。默认是1次。
delay_before_retry &lt;INT&gt;：默认是1秒。在重试之前延迟多少秒。
}


SMTP_CHECK {
connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。
connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。 默认是25端口
bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。
bind_port &lt;PORT&gt;：发起连接的源端口。
connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。
fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。

retry &lt;INT&gt;：重试次数。
delay_before_retry &lt;INT&gt;：在重试之前延迟多少秒。
helo_name &lt;STRING&gt;：用于SMTP HELO请求的字符串。
}


DNS_CHECK {
connect_ip &lt;IP ADDRESS&gt;：连接的IP地址。默认是real server的ip地址。
connect_port &lt;PORT&gt;：连接的端口。默认是real server的端口。 默认是25端口
bindto &lt;IP ADDRESS&gt;：发起连接的接口的地址。
bind_port &lt;PORT&gt;：发起连接的源端口。
connect_timeout &lt;INT&gt;：连接超时时间。默认是5s。
fwmark &lt;INTEGER&gt;：使用fwmark对所有出去的检查数据包进行标记。
warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。

retry &lt;INT&gt;：重试次数。默认是3次。
type &lt;STRING&gt;：DNS query type。A/NS/CNAME/SOA/MX/TXT/AAAA
name &lt;STRING&gt;：DNS查询的域名。默认是(.)
}



MISC_CHECK {
 misc_path &lt;STRING&gt;：外部的脚本或程序路径。
 misc_timeout &lt;INT&gt;：脚本执行超时时间。
 user USERNAME [GROUPNAME]：指定运行该脚本的用户和组。如果没有指定GROUPNAME，则GROUPNAME同USERNAME。
 misc_dynamic：根据退出状态码动态调整权重。
  0，健康检查成功，权重不变。
  1，健康检查失败。
  2-255，健康检查成功。权重设置为退出状态码减去2.如退出状态码是250，则权重调整为248
   warmup &lt;INT&gt;：指定一个随机延迟，最大为N秒。可防止网络阻塞。如果为0，则关闭该功能。
}
</pre></div>

<h2 id="keepalived_1">修改Keepalived日志<a class="headerlink" href="#keepalived_1" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span># keepalived 默认将日志输出到系统日志/var/log/messages中
vi /etc/sysconfig/keepalived

# Options for keepalived. See `keepalived --help&#39;output and keepalived(8) and
# keepalived.conf(5) man pages for a list of all options. Here are the most
# common ones :
#
# --vrrp               -P    Only run with VRRP subsystem.
# --check              -C    Only run with Health-checker subsystem.
# --dont-release-vrrp  -V    Dont remove VRRP VIPs &amp; VROUTEs on daemon stop.
# --dont-release-ipvs  -I    Dont remove IPVS topology on daemon stop.
# --dump-conf          -d    Dump the configuration data.
# --log-detail         -D    Detailed log messages.
# --log-facility       -S    0-7 Set local syslog facility (default=LOG_DAEMON)(日志的级别)
#

# 把 KEEPALIVED_OPTIONS=”-D” 修改为 KEEPALIVED_OPTIONS=”-D -d -S 0”，其中 -S 指定 syslog 的 facility
KEEPALIVED_OPTIONS=&quot;-D -d -S 0&quot;

# 修改 /etc/rsyslog.conf 末尾添加
vi /etc/rsyslog.conf
local0.*                                                /var/log/keepalived.log

# 重启日志记录服务
systemctl restart rsyslog

# 重启 keepalived
systemctl restart keepalived

日志级别：指定触发日志事件的级别
</pre></div>

<h2 id="lvs-natkeepalived">LVS-NAT+Keepalived主从部署示例<a class="headerlink" href="#lvs-natkeepalived" title="Permanent link">&para;</a></h2>
<p>LVS-DR修改virtual_server下lb_kind NAT参数为lb_kind DR(LVS-DR为常用方式)</p>
<table>
<thead>
<tr>
<th align="center">IP地址</th>
<th align="center">主机名</th>
<th align="center">类型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">1.1.1.10</td>
<td align="center">LVS-Master</td>
<td align="center">VIP</td>
</tr>
<tr>
<td align="center">192.168.1.10</td>
<td align="center">LVS-Master</td>
<td align="center">DIP</td>
</tr>
<tr>
<td align="center">1.1.1.20</td>
<td align="center">LVS-Backup</td>
<td align="center">VIP</td>
</tr>
<tr>
<td align="center">192.168.1.20</td>
<td align="center">LVS-Backup</td>
<td align="center">DIP</td>
</tr>
<tr>
<td align="center">192.168.1.100</td>
<td align="center">Web-node1</td>
<td align="center">realserver1</td>
</tr>
<tr>
<td align="center">192.168.1.200</td>
<td align="center">Web-node2</td>
<td align="center">realserver2</td>
</tr>
<tr>
<td align="center">1.1.1.131</td>
<td align="center">client</td>
<td align="center">client</td>
</tr>
</tbody>
</table>
<p>公网浮动IP：1.1.1.1
内网浮动IP：192.168.1.1</p>
<p>eth0:1.1.1.10   ___________            ___________
VIP            |           |         |           |<br />
               | LVS-Master|—— —— —— —| Web-node1 |192.168.1.100
               |___________|       <strong>/|_________</strong>|
eth1:192.168.1.10  |               /|
DIP                |              /
 ________          |             /
|        |         |            \/
| client |—— —— —— —            /\
|________|         |           /  \
                   |          /    \
                   |         /      \
eth0:1.1.1.20   <strong><em>|____</em></strong> /       <em>\/__________</em>
VIP            |           |         |           |
               | LVS-Backup|—— —— —— —| Web-node2 |192.168.1.200
DIP            |___________|         /|___________|
eth1:192.168.1.20</p>
<h2 id="lvsip">LVS服务器上配置IP<a class="headerlink" href="#lvsip" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>vim /etc/sysconfig/network-scripts/ifcfg-eth0
vim /etc/sysconfig/network-scripts/ifcfg-eth1

<span class="c1"># 修改内核参数</span>
vim /etc/sysctl.conf
net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span>
net.ipv4.conf.all.send_redirects <span class="o">=</span> <span class="m">0</span>
net.ipv4.conf.default.send_redirects <span class="o">=</span> <span class="m">0</span>
net.ipv4.conf.eth0.send_redirects <span class="o">=</span> <span class="m">0</span>
sysctl -p

<span class="c1"># realserver分别执行以下命令</span>
<span class="c1"># 绑定vip(centos6)</span>
ifconfig lo:0 <span class="m">1</span>.1.1.1 netmask <span class="m">255</span>.255.255.255 broadcast <span class="m">1</span>.1.1.1
<span class="c1"># (centos7)</span>
ip a a <span class="m">1</span>.1.1.1/24 dev lo:0

<span class="c1"># arp抑制</span>
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore
<span class="nb">echo</span> <span class="s2">&quot;2&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore
<span class="nb">echo</span> <span class="s2">&quot;2&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce
<span class="c1"># arp_ignore:定义接收到ARP请求时的响应级别</span>
<span class="m">0</span>：只要本地配置的有对应地址，就给予回应；默认
<span class="m">1</span>：仅在请求的目的地址配置在到达的接口上时，才给予回应

<span class="c1"># arp_announce：定义将自己的地址向外通告时的通告级别</span>
<span class="m">0</span>：将本地任何接口上的任何地址向外通告；默认
<span class="m">1</span>：试图仅向目标网络通告其网络匹配的地址
<span class="m">2</span>：仅向与本地接口上地址匹配的网络进行通告

<span class="c1"># 单个实例必须相同的配置项</span>
vrrp_instance VI_1
virtual_router_id <span class="m">51</span>
auth_type PASS
auth_pass <span class="m">1111</span>
virtual_ipaddress

<span class="c1"># 单个实例必须不相同的配置项</span>
router_id id1
state MASTER  
priority <span class="m">100</span>

<span class="c1"># 上述简化设置--在realserver创建脚本rs.sh</span>
<span class="c1">#!/bin/bash</span>
<span class="c1">#适用于centos6</span>
<span class="nv">vip1</span><span class="o">=</span><span class="m">1</span>.1.1.10
<span class="nv">vip2</span><span class="o">=</span><span class="m">1</span>.1.1.20
<span class="nv">dev1</span><span class="o">=</span>lo:1
<span class="nv">dev2</span><span class="o">=</span>lo:2
<span class="k">case</span> <span class="nv">$1</span> in
start<span class="o">)</span>
    <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
    <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
    <span class="nb">echo</span> <span class="m">2</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce
    <span class="nb">echo</span> <span class="m">2</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
    ifconfig <span class="nv">$dev1</span> <span class="nv">$vip1</span> netmask <span class="m">255</span>.255.255.255 broadcast <span class="nv">$vip</span> up
    ifconfig <span class="nv">$dev2</span> <span class="nv">$vip2</span> netmask <span class="m">255</span>.255.255.255 broadcast <span class="nv">$vip2</span> up
    sysctl -p &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="nb">echo</span> <span class="s2">&quot;VS Server is Ready!&quot;</span>
    <span class="p">;;</span>
stop<span class="o">)</span>
    ifconfig <span class="nv">$dev</span> down
    <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
    <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
    <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce
    <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
    <span class="nb">echo</span> <span class="s2">&quot;VS Server is Cancel!&quot;</span>
    <span class="p">;;</span>
*<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage `basename </span><span class="nv">$0</span><span class="s2">` start|stop&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
    <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>

<h2 id="lvskeepalived_1">LVS服务器上分别安装并配置keepalived<a class="headerlink" href="#lvskeepalived_1" title="Permanent link">&para;</a></h2>
<h3 id="lvskeepalivedconf">主LVS配置keepalived.conf<a class="headerlink" href="#lvskeepalivedconf" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>global_defs <span class="o">{</span>
    notification_email <span class="o">{</span>
         your_email@qq.com   <span class="c1"># 邮件发生目的人</span>
       <span class="o">}</span>
    notification_email_from keepalived@localhost
    smtp_server <span class="m">127</span>.0.0.1 <span class="c1">#本机邮件服务器</span>
    smtp_connect_timeout <span class="m">30</span> <span class="c1">#超时时间</span>
    router_id LVS_R1  <span class="c1"># 标识服务器ID</span>
<span class="o">}</span>

vrrp_sync_group VG1 <span class="o">{</span>   <span class="c1"># 设置实例组</span>
    group <span class="o">{</span>
        VI_1
        VI_2
    <span class="o">}</span>
<span class="o">}</span>

vrrp_instance VI_1 <span class="o">{</span>    <span class="c1"># 实例名称，实例可以一个，也可多个</span>
state MASTER    <span class="c1"># 主LVS服务器</span>
interface eth0  <span class="c1"># 网卡接口</span>
virtual_router_id <span class="m">1</span> <span class="c1"># 服务器id</span>
priority <span class="m">100</span>    <span class="c1"># 优先级(0~255)</span>
advert_int <span class="m">1</span>    <span class="c1"># 心跳检测1秒每次</span>
authentication <span class="o">{</span>    <span class="c1"># 设置验证，master和backup必须相同</span>
    auth_type PASS  <span class="c1"># 基于密码验证类型</span>
    auth_pass <span class="m">1111</span>  <span class="c1"># 密码</span>
<span class="o">}</span>
virtual_ipaddress <span class="o">{</span>
    <span class="m">1</span>.1.1.1 <span class="c1"># 公网浮动IP</span>
 <span class="o">}</span>
<span class="o">}</span>
vrrp_instance VI_2 <span class="o">{</span>
state MASTER
interface eth1
virtual_router_id <span class="m">1</span>
priority <span class="m">100</span>
advert_int <span class="m">1</span>
authentication <span class="o">{</span>
    auth_type PASS
    auth_pass <span class="m">1111</span>
<span class="o">}</span>
virtual_ipaddress <span class="o">{</span>
    <span class="m">192</span>.168.1.1 <span class="c1"># 内网浮动IP</span>
 <span class="o">}</span>
<span class="o">}</span>
virtual_server <span class="m">1</span>.1.1.1 <span class="m">80</span> <span class="o">{</span>
delay_loop <span class="m">15</span>   <span class="c1"># 健康检查的时间</span>
lb_algo rr      <span class="c1"># 调度算法</span>
lb_kind NAT      <span class="c1"># 负载均衡群集的调度方式</span>
protocol TCP
    real_server <span class="m">192</span>.168.1.100 <span class="m">80</span> <span class="o">{</span>
        weight <span class="m">1</span>    <span class="c1"># 权重值</span>
        TCP_CHECK <span class="o">{</span> <span class="c1"># 健康检查方式</span>
            connect_port <span class="m">80</span>     <span class="c1"># 检查目标端口</span>
            connect_timeout <span class="m">3</span>   <span class="c1"># 链接超时时间</span>
            nb_get_retry <span class="m">3</span>      <span class="c1"># 重试次数</span>
            delay_before_retry <span class="m">4</span>  <span class="c1"># 重试间隔时间</span>
        <span class="o">}</span>
    <span class="o">}</span>
    real_server <span class="m">192</span>.168.1.200 <span class="m">80</span> <span class="o">{</span>
        weight <span class="m">1</span>
        TCP_CHECK <span class="o">{</span>
            connect_port <span class="m">80</span>
            connect_timeout <span class="m">3</span>
            nb_get_retry <span class="m">3</span>
            delay_before_retry <span class="m">4</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h3 id="lvs_1">从LVS配置<a class="headerlink" href="#lvs_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>global_defs <span class="o">{</span>
router_id LVS_R1
<span class="o">}</span>

vrrp_sync_group VG1 <span class="o">{</span>
    group <span class="o">{</span>
        VI_1
        VI_2
    <span class="o">}</span>
<span class="o">}</span>

vrrp_instance VI_1 <span class="o">{</span>
state BACKUP
interface eth0
virtual_router_id <span class="m">1</span>
priority <span class="m">90</span>
advert_int <span class="m">1</span>
authentication <span class="o">{</span>
    auth_type PASS
    auth_pass <span class="m">1111</span>
<span class="o">}</span>
virtual_ipaddress <span class="o">{</span>
    <span class="m">1</span>.1.1.1
 <span class="o">}</span>
<span class="o">}</span>
vrrp_instance VI_2 <span class="o">{</span>
state BACKUP
interface eth1
virtual_router_id <span class="m">1</span>
priority <span class="m">90</span>
advert_int <span class="m">1</span>
authentication <span class="o">{</span>
    auth_type PASS
    auth_pass <span class="m">1111</span>
<span class="o">}</span>
virtual_ipaddress <span class="o">{</span>
    <span class="m">192</span>.168.1.1
 <span class="o">}</span>
<span class="o">}</span>
virtual_server <span class="m">1</span>.1.1.1 <span class="m">80</span> <span class="o">{</span>
delay_loop <span class="m">15</span>   <span class="c1"># 健康检查的时间</span>
lb_algo rr      <span class="c1"># 调度算法</span>
lb_kind NAT      <span class="c1"># 负载均衡群集的模式</span>
protocol TCP
    real_server <span class="m">192</span>.168.1.100 <span class="m">80</span> <span class="o">{</span>
        weight <span class="m">1</span>    <span class="c1"># 权重值</span>
        TCP_CHECK <span class="o">{</span>
            connect_port <span class="m">80</span>     <span class="c1"># 检查目标端口</span>
            connect_timeout <span class="m">3</span>   <span class="c1"># 链接超时时间</span>
            nb_get_retry <span class="m">3</span>      <span class="c1"># 重试次数</span>
            delay_before_retry <span class="m">4</span>  <span class="c1"># 重试间隔时间</span>
        <span class="o">}</span>
    <span class="o">}</span>
    real_server <span class="m">192</span>.168.1.200 <span class="m">80</span> <span class="o">{</span>
        weight <span class="m">1</span>
        TCP_CHECK <span class="o">{</span>
            connect_port <span class="m">80</span>
            connect_timeout <span class="m">3</span>
            nb_get_retry <span class="m">3</span>
            delay_before_retry <span class="m">4</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h2 id="lvs_notifysh">创建通用单独的检查邮件提醒脚本lvs_notify.sh<a class="headerlink" href="#lvs_notifysh" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">contact</span><span class="o">=</span><span class="s1">&#39;your_email_address&#39;</span>

notify<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">mailsubject</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2"> to be </span><span class="nv">$1</span><span class="s2">, vip floating&quot;</span>
    <span class="nb">local</span> <span class="nv">mailbody</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date +<span class="s1">&#39;%F %T&#39;</span><span class="k">)</span><span class="s2">: vrrp transition, </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2"> changed to be </span><span class="nv">$1</span><span class="s2">&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$mailbody</span><span class="s2">&quot;</span> <span class="p">|</span> mail -s <span class="s2">&quot;</span><span class="nv">$mailsubject</span><span class="s2">&quot;</span> <span class="nv">$contact</span>
<span class="o">}</span>

<span class="k">case</span> <span class="nv">$1</span> in
master<span class="o">)</span>
    notify master
    <span class="p">;;</span>
backup<span class="o">)</span>
    notify backup
    <span class="p">;;</span>
fault<span class="o">)</span>
    notify fault
    <span class="p">;;</span>
*<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="k">$(</span>basename <span class="nv">$0</span><span class="k">)</span><span class="s2"> {master|backup|fault}&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
    <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Monitors/" title="SomelseMonitors" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  后退
                </span>
                SomelseMonitors
              </span>
            </div>
          </a>
        
        
          <a href="../Haproxy/" title="HAProxy" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  前进
                </span>
                HAProxy
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/Black-Gold" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://www.instagram.com/black0gold/" class="md-footer-social__link fa fa-instagram"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../assets/javascripts/lunr/lunr.jp.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>
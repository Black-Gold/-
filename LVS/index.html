



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="A Material Design theme for MyNotes">
      
      
      
        <meta name="author" content="Anonymous">
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>LVS - Material Design for MyNotes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="manifest" href="../manifest.webmanifest">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-131093963-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="light-green">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#linux-virtual-server" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Material Design for MyNotes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Material Design for MyNotes
            </span>
            <span class="md-header-nav__topic">
              
                LVS
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/Black-Gold/MyNotes/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Black-Gold/MyNotes
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Material Design for MyNotes" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Material Design for MyNotes
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/Black-Gold/MyNotes/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Black-Gold/MyNotes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Vim/" title="Vim" class="md-nav__link">
      Vim
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Languages
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Languages
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Regex_Lua/" title="Regex&Lua" class="md-nav__link">
      Regex&Lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Shell/" title="Shell" class="md-nav__link">
      Shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Python3/" title="Python3" class="md-nav__link">
      Python3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Go/" title="Go" class="md-nav__link">
      Go
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Servers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Servers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Utilities/" title="Iproute2&Net-tools" class="md-nav__link">
      Iproute2&Net-tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Iptables/" title="Iptables" class="md-nav__link">
      Iptables
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Firewalld/" title="Firewalld" class="md-nav__link">
      Firewalld
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Windows/" title="WindowsServer" class="md-nav__link">
      WindowsServer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Ansible/" title="Ansible" class="md-nav__link">
      Ansible
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      WebServer
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        WebServer
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Nginx/" title="Nginx&Unit" class="md-nav__link">
      Nginx&Unit
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Apache/" title="Apache&PHP-FPM" class="md-nav__link">
      Apache&PHP-FPM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tomcat/" title="Tomcat" class="md-nav__link">
      Tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Caddy/" title="Caddy" class="md-nav__link">
      Caddy
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../MySQL/" title="MySQL&MariaDB" class="md-nav__link">
      MySQL&MariaDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Oracle/" title="Oracle" class="md-nav__link">
      Oracle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../MongoDB/" title="MongoDB" class="md-nav__link">
      MongoDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Redis/" title="Redis" class="md-nav__link">
      Redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Memcached/" title="Memcached" class="md-nav__link">
      Memcached
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Zabbix/" title="Zabbix" class="md-nav__link">
      Zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Elk/" title="ELKStack" class="md-nav__link">
      ELKStack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Prometheus/" title="Prometheus" class="md-nav__link">
      Prometheus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Grafana/" title="Grafana" class="md-nav__link">
      Grafana
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      ContainerEcosystem
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        ContainerEcosystem
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Docker/" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Coreos/" title="ContainerOS" class="md-nav__link">
      ContainerOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Landscape/" title="Landscape" class="md-nav__link">
      Landscape
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      CI/CD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        CI/CD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Git/" title="Git&GitLab" class="md-nav__link">
      Git&GitLab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Jenkins/" title="Jenkins" class="md-nav__link">
      Jenkins
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      OptimisingWebDelivery
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        OptimisingWebDelivery
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Squid/" title="Squid" class="md-nav__link">
      Squid
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Varnish/" title="Varnish" class="md-nav__link">
      Varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Stunnel/" title="Stunnel" class="md-nav__link">
      Stunnel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../TrafficServer/" title="ApacheTrafficServer" class="md-nav__link">
      ApacheTrafficServer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11" checked>
    
    <label class="md-nav__link" for="nav-11">
      LB&HA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        LB&HA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        LVS
      </label>
    
    <a href="./" title="LVS" class="md-nav__link md-nav__link--active">
      LVS
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lvskeepalived" title="LVS+Keepalived解决方案官方示例" class="md-nav__link">
    LVS+Keepalived解决方案官方示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived" title="Keepalived配置文件详解" class="md-nav__link">
    Keepalived配置文件详解
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vrrpd" title="VRRPD配置包含如下子块" class="md-nav__link">
    VRRPD配置包含如下子块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs" title="LVS配置" class="md-nav__link">
    LVS配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived_1" title="修改Keepalived日志" class="md-nav__link">
    修改Keepalived日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs-natkeepalived" title="LVS-NAT+Keepalived主从部署示例" class="md-nav__link">
    LVS-NAT+Keepalived主从部署示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvsip" title="LVS服务器上配置IP" class="md-nav__link">
    LVS服务器上配置IP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvskeepalived_1" title="LVS服务器上分别安装并配置keepalived" class="md-nav__link">
    LVS服务器上分别安装并配置keepalived
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lvskeepalivedconf" title="主LVS配置keepalived.conf" class="md-nav__link">
    主LVS配置keepalived.conf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lvs_1" title="从LVS配置" class="md-nav__link">
    从LVS配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs_notifysh" title="创建通用单独的检查邮件提醒脚本lvs_notify.sh" class="md-nav__link">
    创建通用单独的检查邮件提醒脚本lvs_notify.sh
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Haproxy/" title="HAProxy" class="md-nav__link">
      HAProxy
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      MessageQueue
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        MessageQueue
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../ActiveMQ/" title="ActiveMQ" class="md-nav__link">
      ActiveMQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Kafka/" title="Kafka" class="md-nav__link">
      Kafka
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RabbitMQ/" title="RabbitMQ" class="md-nav__link">
      RabbitMQ
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      FileSystem
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        FileSystem
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Ceph/" title="Ceph" class="md-nav__link">
      Ceph
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../GlusterFS/" title="GlusterFS" class="md-nav__link">
      GlusterFS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#lvskeepalived" title="LVS+Keepalived解决方案官方示例" class="md-nav__link">
    LVS+Keepalived解决方案官方示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived" title="Keepalived配置文件详解" class="md-nav__link">
    Keepalived配置文件详解
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vrrpd" title="VRRPD配置包含如下子块" class="md-nav__link">
    VRRPD配置包含如下子块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs" title="LVS配置" class="md-nav__link">
    LVS配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keepalived_1" title="修改Keepalived日志" class="md-nav__link">
    修改Keepalived日志
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs-natkeepalived" title="LVS-NAT+Keepalived主从部署示例" class="md-nav__link">
    LVS-NAT+Keepalived主从部署示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvsip" title="LVS服务器上配置IP" class="md-nav__link">
    LVS服务器上配置IP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvskeepalived_1" title="LVS服务器上分别安装并配置keepalived" class="md-nav__link">
    LVS服务器上分别安装并配置keepalived
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lvskeepalivedconf" title="主LVS配置keepalived.conf" class="md-nav__link">
    主LVS配置keepalived.conf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lvs_1" title="从LVS配置" class="md-nav__link">
    从LVS配置
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvs_notifysh" title="创建通用单独的检查邮件提醒脚本lvs_notify.sh" class="md-nav__link">
    创建通用单独的检查邮件提醒脚本lvs_notify.sh
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Black-Gold/MyNotes/edit/master/docs/LVS.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="linux-virtual-server">Linux Virtual Server<a class="headerlink" href="#linux-virtual-server" title="Permanent link">&para;</a></h1>
<div class="codehilite"><pre><span></span><span class="n">Linux虚拟服务器是一个高度可扩展且高度可用的服务器</span><span class="err">，构建在真实服务器集群上。服务器群集的体系结构对最终用户完全透明，用户与群集系统进行交互，就好像它只是一个高性能的虚拟服务器一样。</span>
</pre></div>

<p><img alt="figure" src="http://www.linuxvirtualserver.org/VirtualServer.png" /></p>
<div class="codehilite"><pre><span></span><span class="err">真实服务器和负载平衡器可以通过高速</span><span class="n">LAN或地理上分散的WAN互连</span><span class="err">。负载均衡器可以将请求分派给不同的服务器，并使群集的并行服务在单个</span><span class="n">IP地址上显示为虚拟服务</span><span class="err">，请求分派可以使用</span><span class="n">IP负载平衡技术或应用级负载均衡技术</span><span class="err">。通过透明地添加或删除集群中的节点来实现系统的可伸缩性。通过检测节点或守护程序故障并适当地重新配置系统来提供高可用性。</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="err">构建服务器集群方法：</span>
<span class="n">DNS负载平衡</span><span class="err">：</span>
<span class="err">简单，利用域名系统将域名解析到服务器不同的</span><span class="n">IP来分发请求</span><span class="err">，</span><span class="n">DNS服务器根据调度策略</span><span class="p">(</span><span class="err">如循环方式</span><span class="p">)</span><span class="err">发出服务器</span><span class="n">IP地址</span><span class="err">，然后使用相同的本地缓存域名服务器在指定的域名解析生存时间</span><span class="p">(</span><span class="n">TTL</span><span class="p">)</span><span class="err">中发送到同一个服务器。</span>
<span class="err">但是，由于客户端和分层</span><span class="n">DNS系统的缓存特性</span><span class="err">，很容易导致服务器之间的动态负载不平衡，因此服务器不容易处理其峰值负载。在</span><span class="n">DNS服务器上无法很好地选择名称映射的TTL值</span><span class="err">，小值</span><span class="n">DNS流量很高且DNS服务器将成为瓶颈</span><span class="err">，并且具有高值，动态负载不平衡将变得更糟。即使</span><span class="n">TTL值设置为零</span><span class="err">，调度粒度是每个主机，不同用户的访问模式可能会导致动态负载不平衡，因为有些人可能从网站上抽取大量页面，而其他人可能只是浏览几页然后去远。此外，它不太可靠，当服务器节点发生故障时，将名称映射到</span><span class="n">IP地址的客户端将发现服务器已关闭</span>

<span class="err">基于调度程序的负载平衡群集：</span>
<span class="err">可用于在群集中的服务器之间分配负载，以便服务器的并行服务可以在单个</span><span class="n">IP地址上显示为虚拟服务</span><span class="err">，并且最终用户可以像单个服务器一样进行交互不知道集群中的所有服务器。与基于</span><span class="n">DNS的负载平衡相比</span><span class="err">，调度程序可以以精细的粒度（例如每个连接）调度请求，以便在服务器之间实现更好的负载平衡。当一台或多台服务器发生故障时，可以屏蔽故障。服务器管理变得越来越容易，管理员可以随时使用服务器或更多服务器，这不会中断最终用户的服务。</span>

<span class="err">负载均衡可以在两个级别完成，即应用级和</span><span class="n">IP级</span><span class="err">。将</span><span class="n">HTTP请求转发到集群中的不同Web服务器</span><span class="err">，获取结果，然后将其返回给客户端。由于在应用程序级别处理</span><span class="n">HTTP请求和回复的开销很高</span><span class="err">，当服务器节点数量增加到</span><span class="mi">5</span><span class="err">或更多时，应用程序级负载均衡器将成为新的瓶颈，这取决于每个服务器节点的吞吐量服务器</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="n">LinuxVirtualServer以三种IP负载均衡技术</span><span class="p">(</span><span class="err">数据包转发方法</span><span class="p">)</span><span class="err">实现。</span>
<span class="mi">1</span><span class="p">.</span> <span class="n">NAT方式</span>
<span class="mi">2</span><span class="p">.</span> <span class="n">IP隧道</span>
<span class="mi">3</span><span class="p">.</span> <span class="err">直接路由</span>
</pre></div>

<p>VS/NAT，VS/TUN和VS/DR的比较：
|      对比方面       |   VS/NAT   |  VS/TUN   |   VS/DR    |
| :-----------------: | :--------: | :-------: | :--------: |
|     realserver      |    任何    |   隧道    | 非ARP设备  |
| realserver network  |    私有    |  lan/wan  |    lan     |
| realserver numbers  | low(10-20) |   high    |    high    |
| realserver gateway  |  director  | ownrouter | own router |
| client connnects to |    VIP     |    VIP    |    VIP     |</p>
<p>LVS集群通常采用三连接架构：
<img alt="architecture" src="http://www.linuxvirtualserver.org/lvs_architecture.jpg" /></p>
<p>三连接结构包括：</p>
<p>**负载均衡器**它是整个集群系统的前端机器，并在一组服务器之间平衡来自客户端的请求，以便客户端认为所有服务都来自单个IP地址。</p>
<p>**服务器群集**它是一组运行实际网络服务的服务器，例如Web，邮件，FTP，DNS和媒体服务。</p>
<p>**共享存储**为服务器提供共享存储空间，以便服务器可以轻松拥有相同的内容并提供相同的服务。</p>
<p>NAT:
NAT(Network Address Translation)网络地址转换即将IP地址从一个组映射到另一个组的功能。当地址映射为N到N时，称为静态网络地址转换; 当映射是M到N（M&gt; N）时，它被称为动态网络地址转换。网络地址端口转换是基本NAT的扩展，因为许多网络地址及其TCP/UDP端口被转换为单个网络地址及其TCP/UDP端口。这是N-to-1映射，实现了Linux IP Masquerading(伪装)。Linux上的NAT虚拟服务器是通过网络地址端口转换完成的
<img alt="architecture" src="http://www.linuxvirtualserver.org/VS-NAT.gif" />
当用户访问服务器集群提供的服务时，发往虚拟IP地址的请求数据包（负载均衡器的外部IP地址）到达负载均衡器。负载均衡器检查数据包的目标地址和端口号。如果根据虚拟服务器规则表匹配虚拟服务器服务，则通过调度算法从集群中选择真实服务器，并将连接添加到记录已建立连接的哈希表中。然后，将目标地址和数据包的端口重写为所选服务器的目标地址和端口，并将数据包转发到服务器。当传入数据包属于此连接并且可以在哈希表中找到所选服务器时，将重写该数据包并将其转发到所选服务器。当回复数据包返回时，负载均衡器将数据包的源地址和端口重写为虚拟服务的源地址和端口。连接终止或超时后，连接记录将在哈希表中删除。</p>
<p>IP隧道：
IP隧道（IP封装）是一种将IP数据包封装在IP数据报中的技术，它允许将发往一个IP地址的数据报包装并重定向到另一个IP地址。IP封装现在通常用于外联网，移动IP，IP多播，隧道主机或网络。
<img alt="architecture" src="http://www.linuxvirtualserver.org/VS-IPTunneling.gif" />
当用户访问由服务器集群提供的虚拟服务时，到达虚拟IP地址的分组（虚拟服务器的IP地址）到达。负载均衡器检查数据包的目标地址和端口。如果它们匹配虚拟服务，则根据连接调度算法从群集中选择真实服务器，并将连接添加到记录连接的哈希表中。然后，负载均衡器将数据包封装在IP数据报中，并将其转发到所选服务器。当传入数据包属于此连接并且可以在哈希表中找到所选服务器时，将再次封装数据包并将其转发到该服务器。当服务器收到封装的数据包时，它会解封装数据包并处理请求，最后根据自己的路由表将结果直接返回给用户。连接终止或超时后，连接记录将从哈希表中删除。</p>
<p>直接路由:
此请求调度方法类似于IBM的NetDispatcher中实现的方法。虚拟IP地址由真实服务器和负载均衡器共享。负载均衡器的接口也配置了虚拟IP地址，用于接受请求数据包，并直接将数据包路由到选定的服务器。所有真实服务器的非arp别名接口都配置了虚拟IP地址，或者将发往虚拟IP地址的数据包重定向到本地套接字，以便真实服务器可以在本地处理数据包。负载均衡器和真实服务器必须通过HUB / Switch物理连接其中一个接口。通过直接路由的虚拟服务器的体系结构如下所示：
<img alt="architecture" src="http://www.linuxvirtualserver.org/VS-DRouting.gif" />
当用户访问由服务器集群提供的虚拟服务时，到达虚拟IP地址的分组（虚拟服务器的IP地址）到达。负载均衡器（LinuxDirector）检查数据包的目标地址和端口。如果它们匹配虚拟服务，则通过调度算法从群集中选择真实服务器，并将连接添加到记录连接的哈希表中。然后，负载均衡器直接将其转发到所选服务器。当传入数据包属于此连接并且可以在哈希表中找到所选服务器时，该数据包将再次直接路由到服务器。当服务器收到转发的数据包时，服务器发现该数据包是用于其别名接口上的地址或本地套接字的地址，所以它处理请求并最终将结果直接返回给用户。连接终止或超时后，连接记录将从哈希表中删除。</p>
<p>作业调度算法：
循环调度Round Robin PR
加权循环调度Weighted Round Robin WPR
最小连接调度Least Connections LC
加权最小连接调度Weighted Least Connections WLC
基于位置的最小连接调度Locality-Based Least Connections LBLC
基于位置的最小连接与复制调度Locality-Based Least Connections with Replication LBLCR
目的地哈希调度Destination Hashing DH
源哈希调度Source Hashing SH
最短的预期延迟调度Shortest Expected Delay Scheduling SED
从不排队调度Never Queue Scheduling NQ</p>
<p>循环调度
循环调度算法将每个传入请求发送到其列表中的下一个服务器。因此，在三服务器集群（服务器A，B和C）中，请求1将转到服务器A，请求2将转到服务器B，请求3将转到服务器C，请求4将转到服务器A，从而完成骑自行车或服务器'循环'。无论每个服务器遇到的传入连接数或响应时间如何，它都将所有真实服务器视为相等。与传统的循环DNS相比，Virtual Server具有一些优势。循环DNS将单个域解析为不同的IP地址，调度粒度是基于主机的，并且DNS查询的缓存阻碍了基本算法，这些因素导致真实服务器之间显着的动态负载不平衡。</p>
<p>加权循环调度
加权循环调度旨在更好地处理具有不同处理能力的服务器。可以为每个服务器分配一个权重，一个表示处理能力的整数值。具有较高权重的服务器首先接收新连接，而不是权重较小的服务器，具有较高权重的服务器比具有较少权重的服务器获得更多连接，具有相同权重的服 例如，真实服务器A，B和C分别具有权重4,3,2，在调度周期（mod sum（Wi））中，良好的调度序列将是AABABCABC。在加权循环调度的实现中，在修改虚拟服务器的规则之后，将根据服务器权重生成调度序列。</p>
<p>当真实服务器的处理能力不同时，加权循环调度优于循环调度。但是，如果请求的负载变化很大，则可能导致真实服务器之间的动态负载不平衡。简而言之，大多数需要大响应的请求可能会被引导到同一个真实服务器。</p>
<p>实际上，循环调度是加权循环调度的一个特殊实例，其中所有权重都相等。</p>
<p>最小连接调度
最少连接调度算法将网络连接定向到具有最少数量的已建立连接的服务器。这是动态调度算法之一; 因为它需要动态计算每个服务器的实时连接。对于管理具有类似性能的服务器集合的虚拟服务器，当请求的负载变化很大时，最少连接调度可以平滑分发。虚拟服务器将使用最少的活动连接将请求定向到真实服务器。</p>
<p>乍一看，即使存在各种处理能力的服务器，最少连接调度也可能表现良好，因为更快的服务器将获得更多的网络连接。实际上，由于TCP的TIME_WAIT状态，它无法很好地执行。TCP的TIME_WAIT通常是2分钟，在这2分钟内，一个繁忙的网站经常收到数千个连接，例如，服务器A的功能是服务器B的两倍，服务器A处理数千个请求并将它们保存在TCP的TIME_WAIT状态，但服务器B正在爬行以完成其数千个连接。因此，最少连接调度不能在具有各种处理能力的服务器之间很好地平衡负载。</p>
<p>加权最小连接调度
加权最小连接调度是最小连接调度的超集，您可以在其中为每个真实服务器分配性能权重。具有较高权重值的服务器在任何时候都将获得更大比例的实时连接。虚拟服务器管理员可以为每个真实服务器分配权重，并且将网络连接安排到每个服务器，其中每个服务器的当前活动连接数的百分比是与其权重的比率。默认权重为1。</p>
<p>加权最小连接调度的工作原理如下：
假设有n个真实服务器，每个服务器i的权重为W i（i = 1，..，n），而活动连接C i （i = 1，..，n），ALL_CONNECTIONS是C i的总和 （i = 1，..，n），下一个网络连接将被定向到服务器j，其中
（C j / ALL_CONNECTIONS）/ W j = min {（C i / ALL_CONNECTIONS）/ W i }（i = 1，..，n）
由于ALL_CONNECTIONS在此查找中是常量，因此无需将C i除以ALL_CONNECTIONS，它可以优化为
C j / W j = min {C i / W i }（i = 1，..，n）
加权最小连接调度算法需要比最小连接更多的划分。为了在服务器具有相同的处理能力时最小化调度的开销，实现最少连接调度和加权最小连接调度算法。</p>
<p>基于位置的最小连接调度
基于位置的最小连接调度算法用于目标IP负载平衡。它通常用于缓存集群。如果服务器处于活动状态且负载不足，此算法通常会将发往IP地址的数据包定向到其服务器。如果服务器过载（其活动连接数大于其权重）并且服务器处于半负载状态，则将加权最小连接服务器分配给此IP地址。</p>
<p>基于位置的最小连接与复制调度
基于位置的最小连接与复制调度算法也用于目标IP负载平衡。它通常用于缓存集群。它与LBLC调度的不同之处如下：负载均衡器维护从目标到可以为目标服务的一组服务器节点的映射。对目标的请求将分配给目标服务器集中的最小连接节点。如果服务器集中的所有节点都过载，它将在集群中获取最少连接节点，并将其添加到目标服务器集中。如果服务器集未在指定时间内进行修改，则会从服务器集中删除负载最多的节点，以避免高度复制。</p>
<p>目的地哈希调度
目标哈希调度算法通过按目标IP地址查找静态分配的哈希表来为服务器分配网络连接。</p>
<p>源哈希调度
源哈希调度算法通过按源IP地址查找静态分配的哈希表来为服务器分配网络连接。</p>
<p>最短的预期延迟调度
最短的预期延迟调度算法以最短的预期延迟将网络连接分配给服务器。如果发送到第i个服务器，作业将经历的预期延迟是（Ci + 1）/ Ui，其中Ci是第i个服务器上的连接数，Ui是第i个服务器的固定服务速率（权重） 。</p>
<p>从不排队调度
永不排队调度算法采用双速模型。当有空闲服务器可用时，作业将被发送到空闲服务器，而不是等待快速服务器。当没有可用的空闲服务器时，作业将被发送到服务器，以最小化其预期延迟（最短预期延迟调度算法）。</p>
<p>LVS中IP或网络的名称</p>
<div class="codehilite"><pre><span></span>典型的<span class="nv">LVS</span><span class="o">-</span><span class="nv">NAT</span>设置：<span class="nv">LVS</span><span class="o">-</span><span class="nv">NAT</span>: <span class="nv">no</span> <span class="nv">arp</span> <span class="nv">problem</span> <span class="ss">(</span><span class="nv">the</span> <span class="nv">realservers</span> <span class="nv">don</span><span class="s1">&#39;</span><span class="s">t have the VIP)</span>
                        <span class="nv">________</span>
                       <span class="o">|</span>        <span class="o">|</span>
                       <span class="o">|</span> <span class="nv">client</span> <span class="o">|</span> <span class="ss">(</span><span class="nv">local</span> <span class="nv">or</span> <span class="nv">on</span> <span class="nv">internet</span><span class="ss">)</span>
                       <span class="o">|</span><span class="nv">________</span><span class="o">|</span>
                          <span class="nv">CIP</span>
                           <span class="o">|</span>
                        <span class="ss">(</span><span class="nv">router</span><span class="ss">)</span>
                          <span class="nv">DGW</span><span class="o">--</span><span class="nv">DIRECTOR</span><span class="o">-</span><span class="nv">gateway</span>
                           <span class="o">|</span> <span class="nv">outside</span> <span class="nv">network</span>
                           <span class="o">|</span>
                          <span class="nv">VIP</span><span class="o">--</span><span class="nv">Virtual</span> <span class="nv">IP</span>
                       <span class="nv">____</span><span class="o">|</span><span class="nv">_____</span>
                      <span class="o">|</span>          <span class="o">|</span> <span class="ss">(</span><span class="nv">director</span> <span class="nv">can</span> <span class="nv">have</span> <span class="mi">1</span> <span class="nv">or</span> <span class="mi">2</span> <span class="nv">NICs</span><span class="ss">)</span>
                      <span class="o">|</span> <span class="nv">director</span> <span class="o">|</span>
                      <span class="o">|</span><span class="nv">__________</span><span class="o">|</span>
                      <span class="nv">DIP</span> <span class="ss">(</span><span class="nv">and</span> <span class="nv">PIP</span><span class="ss">)</span><span class="o">--</span><span class="nv">primary</span> <span class="nv">director</span> <span class="nv">IP</span> <span class="o">=</span> <span class="nv">PIP</span> <span class="ss">(</span><span class="nv">the</span> <span class="nv">director</span> <span class="nv">which</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">the</span> <span class="nv">master</span> <span class="nv">on</span> <span class="nv">bootup</span><span class="ss">)</span>
                           <span class="o">|</span>       <span class="o">--</span><span class="nv">secondary</span> <span class="nv">director</span> <span class="nv">IP</span> <span class="o">=</span> <span class="nv">SIP</span> <span class="ss">(</span><span class="nv">the</span> <span class="nv">director</span> <span class="nv">which</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">the</span> <span class="nv">backup</span> <span class="nv">on</span> <span class="nv">bootup</span><span class="ss">)</span>
                           <span class="o">|</span> <span class="nv">DRIP</span> <span class="nv">network</span>
          <span class="o">----------------------------------</span>
          <span class="o">|</span>                <span class="o">|</span>               <span class="o">|</span>
          <span class="o">|</span>                <span class="o">|</span>               <span class="o">|</span>
         <span class="nv">RIP1</span>             <span class="nv">RIP2</span>            <span class="nv">RIP3</span>
     <span class="nv">_____________</span>   <span class="nv">_____________</span>   <span class="nv">_____________</span>
    <span class="o">|</span>             <span class="o">|</span> <span class="o">|</span>             <span class="o">|</span> <span class="o">|</span>             <span class="o">|</span>
    <span class="o">|</span> <span class="nv">realserver1</span> <span class="o">|</span> <span class="o">|</span> <span class="nv">realserver2</span> <span class="o">|</span> <span class="o">|</span> <span class="nv">realserver3</span> <span class="o">|</span>
    <span class="o">|</span><span class="nv">_____________</span><span class="o">|</span> <span class="o">|</span><span class="nv">_____________</span><span class="o">|</span> <span class="o">|</span><span class="nv">_____________</span><span class="o">|</span>

典型的<span class="nv">LVS</span><span class="o">-</span><span class="nv">DR</span> <span class="nv">or</span> <span class="nv">LVS</span><span class="o">-</span><span class="nv">Tun</span>设置
                        <span class="nv">________</span>
                       <span class="o">|</span>        <span class="o">|</span>
                       <span class="o">|</span> <span class="nv">client</span> <span class="o">|</span> <span class="ss">(</span><span class="nv">local</span> <span class="nv">or</span> <span class="nv">on</span> <span class="nv">internet</span><span class="ss">)</span>
                       <span class="o">|</span><span class="nv">________</span><span class="o">|</span>
                           <span class="o">|</span>
                        <span class="ss">(</span><span class="nv">router</span><span class="ss">)</span><span class="o">-----------</span>
                           <span class="o">|</span>    <span class="nv">SERVER_GW</span>  <span class="o">|</span>
                           <span class="o">|</span>               <span class="o">|</span>
                          <span class="nv">VIP</span>              <span class="o">|</span>
                       <span class="nv">____</span><span class="o">|</span><span class="nv">_____</span>          <span class="o">|</span>
                      <span class="o">|</span>          <span class="o">|</span> <span class="ss">(</span><span class="nv">director</span> <span class="nv">can</span> <span class="nv">have</span> <span class="mi">1</span> <span class="nv">or</span> <span class="mi">2</span> <span class="nv">NICs</span><span class="ss">)</span>
                      <span class="o">|</span> <span class="nv">director</span> <span class="o">|</span>         <span class="o">|</span>
                      <span class="o">|</span><span class="nv">__________</span><span class="o">|</span>         <span class="o">|</span>
                          <span class="nv">DIP</span>              <span class="o">|</span>
                           <span class="o">|</span>               <span class="o">|</span>
                           <span class="o">|</span>               <span class="o">|</span>
          <span class="o">-----------------+----------------</span>
          <span class="o">|</span>                <span class="o">|</span>               <span class="o">|</span>
          <span class="o">|</span>                <span class="o">|</span>               <span class="o">|</span>
       <span class="nv">RIP1</span>,<span class="nv">VIP</span>         <span class="nv">RIP2</span>,<span class="nv">VIP</span>        <span class="nv">RIP3</span>,<span class="nv">VIP</span>
    <span class="nv">____________</span>     <span class="nv">____________</span>     <span class="nv">____________</span>
   <span class="o">|</span>            <span class="o">|</span>   <span class="o">|</span>            <span class="o">|</span>   <span class="o">|</span>            <span class="o">|</span>
   <span class="o">|</span> <span class="nv">realserver</span> <span class="o">|</span>   <span class="o">|</span> <span class="nv">realserver</span> <span class="o">|</span>   <span class="o">|</span> <span class="nv">realserver</span> <span class="o">|</span>
   <span class="o">|</span><span class="nv">____________</span><span class="o">|</span>   <span class="o">|</span><span class="nv">____________</span><span class="o">|</span>   <span class="o">|</span><span class="nv">____________</span><span class="o">|</span>

<span class="nv">client</span> <span class="nv">IP</span>     <span class="o">=</span> <span class="nv">CIP</span>
<span class="nv">virtual</span> <span class="nv">IP</span>    <span class="o">=</span> <span class="nv">VIP</span> <span class="o">-</span> <span class="nv">the</span> <span class="nv">IP</span> <span class="nv">on</span> <span class="nv">the</span> <span class="nv">director</span> <span class="nv">that</span> <span class="nv">the</span> <span class="nv">client</span> <span class="nv">connects</span> <span class="nv">to</span><span class="ss">)</span>
<span class="nv">director</span> <span class="nv">IP</span>   <span class="o">=</span> <span class="nv">DIP</span> <span class="o">-</span> <span class="nv">the</span> <span class="nv">IP</span> <span class="nv">on</span> <span class="nv">the</span> <span class="nv">director</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">DIP</span><span class="o">/</span><span class="nv">RIP</span> <span class="ss">(</span><span class="nv">DRIP</span><span class="ss">)</span> <span class="nv">network</span>
   <span class="ss">(</span><span class="nv">this</span> <span class="nv">is</span> <span class="nv">the</span> <span class="nv">realserver</span> <span class="nv">gateway</span> <span class="k">for</span> <span class="nv">LVS</span><span class="o">-</span><span class="nv">NAT</span><span class="ss">)</span>
<span class="nv">realserver</span> <span class="nv">IP</span> <span class="o">=</span> <span class="nv">RIP</span> <span class="ss">(</span><span class="nv">and</span> <span class="nv">RIP1</span>, <span class="nv">RIP2</span>...<span class="ss">)</span> <span class="nv">the</span> <span class="nv">IP</span> <span class="nv">on</span> <span class="nv">the</span> <span class="nv">realserver</span>
<span class="nv">director</span> <span class="nv">GW</span>   <span class="o">=</span> <span class="nv">DGW</span> <span class="o">-</span> <span class="nv">the</span> <span class="nv">director</span><span class="s1">&#39;</span><span class="s">s gw (only needed for LVS-NAT)</span>
   <span class="ss">(</span><span class="nv">this</span> <span class="nv">can</span> <span class="nv">be</span> <span class="nv">the</span> <span class="nv">realserver</span> <span class="nv">gateway</span> <span class="k">for</span> <span class="nv">LVS</span><span class="o">-</span><span class="nv">DR</span> <span class="nv">and</span> <span class="nv">LVS</span><span class="o">-</span><span class="nv">Tun</span><span class="ss">)</span>

<span class="nv">VIP</span>和<span class="nv">DIP</span>设置为辅助<span class="nv">IP</span>（即该<span class="nv">NIC</span><span class="ss">(</span>网卡<span class="ss">)</span>上有另一个主<span class="nv">IP</span>），因此可以在<span class="nv">director</span>故障转移后将它们移动到另一个复制的<span class="nv">director</span>。对于使用单个<span class="nv">director</span>的初始设置，将<span class="nv">VIP</span>和<span class="nv">DIP</span>设置为次要<span class="nv">IP</span>将使故障转移设置更加容易。
</pre></div>

<table>
<thead>
<tr>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">DGW</td>
<td align="center">公网IP的默认网关</td>
</tr>
<tr>
<td align="center">VIP</td>
<td align="center">客户端访问的公网IP，Director的虚拟IP</td>
</tr>
<tr>
<td align="center">DIP</td>
<td align="center">Director的真实IP</td>
</tr>
<tr>
<td align="center">RIP</td>
<td align="center">realserver的IP</td>
</tr>
<tr>
<td align="center">RIP</td>
<td align="center">客户端IP</td>
</tr>
</tbody>
</table>
<p>例子：LVS使用LVS-NAT转发</p>
<div class="codehilite"><pre><span></span><span class="err">在</span><span class="n">direcotor使用一个网卡</span><span class="err">，也可使用两个，但要改变设置。</span>
                      <span class="n">________</span>
                     <span class="o">|</span>        <span class="o">|</span>
                     <span class="o">|</span> <span class="n">client</span> <span class="o">|</span>
                     <span class="o">|</span><span class="n">________</span><span class="o">|</span>
                  <span class="n">CIP</span><span class="o">=</span><span class="n">DGW</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">254</span> <span class="p">(</span><span class="n">eth0</span><span class="p">)</span>
                         <span class="o">|</span>
                         <span class="o">|</span>
           <span class="n">__________</span>    <span class="o">|</span>
          <span class="o">|</span>          <span class="o">|</span>   <span class="o">|</span>   <span class="p">(</span><span class="n">VIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">110</span><span class="p">,</span><span class="n">eth0</span><span class="p">:</span><span class="mi">110</span><span class="p">)</span>
          <span class="o">|</span> <span class="n">director</span> <span class="o">|</span><span class="c1">---|</span>
          <span class="o">|</span><span class="n">__________</span><span class="o">|</span>   <span class="o">|</span>   <span class="n">DIP</span><span class="o">=</span><span class="n">SGW</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">9</span><span class="p">(</span><span class="n">eth0</span><span class="p">)</span>
                         <span class="o">|</span>
                         <span class="o">|</span>
        <span class="c1">-----------------------------------</span>
        <span class="o">|</span>                                 <span class="o">|</span>
        <span class="o">|</span>                                 <span class="o">|</span>
<span class="n">RIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">11</span><span class="p">(</span><span class="n">eth0</span><span class="p">)</span>              <span class="n">RIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">12</span><span class="p">(</span><span class="n">eth0</span><span class="p">)</span>
   <span class="n">____________</span>                        <span class="n">____________</span>
  <span class="o">|</span>            <span class="o">|</span>                      <span class="o">|</span>            <span class="o">|</span>
  <span class="o">|</span> <span class="n">realserver</span> <span class="o">|</span>                      <span class="o">|</span> <span class="n">realserver</span> <span class="o">|</span>
  <span class="o">|</span><span class="n">____________</span><span class="o">|</span>                      <span class="o">|</span><span class="n">____________</span><span class="o">|</span>
</pre></div>

<p>例子：LVS使用LVS-DR转发</p>
<div class="codehilite"><pre><span></span><span class="err">在具有单个</span><span class="n">NIC的计算机上使用单个网络</span><span class="err">（此处为</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="err">）设置</span><span class="n">LVS</span><span class="err">。以太网别名上的</span><span class="n">IP</span><span class="err">（例如</span><span class="n">eth0</span><span class="err">：</span><span class="mi">110</span><span class="err">，</span><span class="n">lo</span><span class="err">：</span><span class="mi">0</span><span class="err">）由</span><span class="n">configure脚本设置</span><span class="err">。没有默认路由，并且所有计算机都应该能够相互</span><span class="n">ping通</span><span class="err">。</span>
                        <span class="n">________</span>
                       <span class="o">|</span>        <span class="o">|</span>
                       <span class="o">|</span> <span class="n">client</span> <span class="o">|</span>
                       <span class="o">|</span><span class="n">________</span><span class="o">|</span>
                   <span class="n">CIP</span><span class="o">=</span><span class="n">SGW</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">254</span> <span class="p">(</span><span class="n">eth0</span><span class="p">)</span>
                           <span class="o">|</span>
                           <span class="o">|</span>
             <span class="n">__________</span>    <span class="o">|</span>
            <span class="o">|</span>          <span class="o">|</span>   <span class="o">|</span>   <span class="p">(</span><span class="n">VIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">110</span><span class="p">,</span> <span class="n">eth0</span><span class="p">:</span><span class="mi">110</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">director</span> <span class="o">|</span><span class="c1">---|</span>
            <span class="o">|</span><span class="n">__________</span><span class="o">|</span>   <span class="o">|</span>   <span class="n">DIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">9</span> <span class="p">(</span><span class="n">eth0</span><span class="p">)</span>
                           <span class="o">|</span>
                           <span class="o">|</span>
          <span class="c1">-----------------------------------</span>
          <span class="o">|</span>                                 <span class="o">|</span>
          <span class="o">|</span>                                 <span class="o">|</span>
 <span class="n">RIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">11</span><span class="p">(</span><span class="n">eth0</span><span class="p">)</span>             <span class="n">RIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">12</span><span class="p">(</span><span class="n">eth0</span><span class="p">)</span>
<span class="p">(</span><span class="n">VIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">110</span><span class="p">,</span> <span class="n">lo</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>          <span class="p">(</span><span class="n">VIP</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">110</span><span class="p">,</span> <span class="n">lo</span><span class="p">:</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">____________</span>                       <span class="n">____________</span>
   <span class="o">|</span>            <span class="o">|</span>                     <span class="o">|</span>            <span class="o">|</span>
   <span class="o">|</span> <span class="n">realserver</span> <span class="o">|</span>                     <span class="o">|</span> <span class="n">realserver</span> <span class="o">|</span>
   <span class="o">|</span><span class="n">____________</span><span class="o">|</span>                     <span class="o">|</span><span class="n">____________</span><span class="o">|</span>
</pre></div>

<h2 id="lvskeepalived">LVS+Keepalived解决方案官方示例<a class="headerlink" href="#lvskeepalived" title="Permanent link">&para;</a></h2>
<p>使用keepalived构建一个具有两个负载平衡器和三个Web服务器的高可用性VS/NAT Web集群，拓扑图如下：
<img alt="topology" src="http://linux-vs.org/docs/ha/keepalived.jpg" />
在本例中，VIP地址和DIP地址分别为10.23.8.80和172.18.1.254均为浮动IP，它们在两个负载均衡器（LD1和LD2）之间浮动，三个realserver的IP地址为172.18.1.11,172.18.1.12和172.18.1.13。
float IP工作原理如下图：
<img alt="yuanlli" src="http://assets.digitalocean.com/blog/static/floating-ips-start-architecting-your-applications-for-high-availability/ha-diagram-animated.gif" />
LD1上的keepalived配置文件（/etc/keepalived/keepalived.conf）如下:</p>
<div class="codehilite"><pre><span></span><span class="n">vrrp_sync_group</span> <span class="n">VG1</span> <span class="err">{</span>
    <span class="k">group</span> <span class="err">{</span>
        <span class="n">VI_1</span>
        <span class="n">VI_2</span>
    <span class="err">}</span>
<span class="err">}</span>

<span class="n">vrrp_instance</span> <span class="n">VI_1</span> <span class="err">{</span>
    <span class="k">state</span> <span class="n">MASTER</span>
    <span class="n">interface</span> <span class="n">eth0</span>
    <span class="n">virtual_router_id</span> <span class="mi">51</span>
    <span class="n">priority</span> <span class="mi">100</span>
    <span class="n">advert_int</span> <span class="mi">1</span>
    <span class="n">authentication</span> <span class="err">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="mi">1111</span>
    <span class="err">}</span>
    <span class="n">virtual_ipaddress</span> <span class="err">{</span>
        <span class="mi">10</span><span class="p">.</span><span class="mi">23</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">80</span>
    <span class="err">}</span>
<span class="err">}</span>

<span class="n">vrrp_instance</span> <span class="n">VI_2</span> <span class="err">{</span>
    <span class="k">state</span> <span class="n">MASTER</span>
    <span class="n">interface</span> <span class="n">eth1</span>
    <span class="n">virtual_router_id</span> <span class="mi">51</span>
    <span class="n">priority</span> <span class="mi">100</span>
    <span class="n">advert_int</span> <span class="mi">1</span>
    <span class="n">authentication</span> <span class="err">{</span>
        <span class="n">auth_type</span> <span class="n">PASS</span>
        <span class="n">auth_pass</span> <span class="mi">1111</span>
    <span class="err">}</span>
    <span class="n">virtual_ipaddress</span> <span class="err">{</span>
        <span class="mi">172</span><span class="p">.</span><span class="mi">18</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">254</span>
    <span class="err">}</span>
<span class="err">}</span>

<span class="n">virtual_server</span> <span class="mi">10</span><span class="p">.</span><span class="mi">23</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">80</span> <span class="mi">80</span> <span class="err">{</span>
    <span class="n">delay_loop</span> <span class="mi">6</span>
    <span class="n">lb_algo</span> <span class="n">wlc</span>
    <span class="n">lb_kind</span> <span class="n">NAT</span>
    <span class="n">persistence_timeout</span> <span class="mi">600</span>
    <span class="n">protocol</span> <span class="n">TCP</span>

    <span class="n">real_server</span> <span class="mi">172</span><span class="p">.</span><span class="mi">18</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">11</span> <span class="mi">80</span> <span class="err">{</span>
        <span class="n">weight</span> <span class="mi">100</span>
        <span class="n">TCP_CHECK</span> <span class="err">{</span>
            <span class="n">connect_timeout</span> <span class="mi">3</span>
        <span class="err">}</span>
    <span class="err">}</span>
    <span class="n">real_server</span> <span class="mi">172</span><span class="p">.</span><span class="mi">18</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">12</span> <span class="mi">80</span> <span class="err">{</span>
        <span class="n">weight</span> <span class="mi">100</span>
        <span class="n">TCP_CHECK</span> <span class="err">{</span>
            <span class="n">connect_timeout</span> <span class="mi">3</span>
        <span class="err">}</span>
    <span class="err">}</span>
    <span class="n">real_server</span> <span class="mi">172</span><span class="p">.</span><span class="mi">18</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">13</span> <span class="mi">80</span> <span class="err">{</span>
        <span class="n">weight</span> <span class="mi">100</span>
        <span class="n">TCP_CHECK</span> <span class="err">{</span>
            <span class="n">connect_timeout</span> <span class="mi">3</span>
        <span class="err">}</span>
    <span class="err">}</span>
<span class="err">}</span>
<span class="n">LD2的和LD1相似</span><span class="err">，只需将</span><span class="n">VI_1和VI_2的状态从master改为backup</span>
</pre></div>

<h2 id="keepalived">Keepalived配置文件详解<a class="headerlink" href="#keepalived" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="err">#</span><span class="w"> </span><span class="n">全局定义模块</span><span class="w"></span>
<span class="n">global_defs</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">   </span><span class="n">notification_email</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">     </span><span class="n">acassen</span><span class="nv">@firewall</span><span class="p">.</span><span class="n">loc</span><span class="w"></span>
<span class="w">     </span><span class="n">failover</span><span class="nv">@firewall</span><span class="p">.</span><span class="n">loc</span><span class="w"></span>
<span class="w">     </span><span class="n">sysadmin</span><span class="nv">@firewall</span><span class="p">.</span><span class="n">loc</span><span class="w"> </span><span class="n">#邮件报警</span><span class="w"></span>
<span class="w">   </span><span class="err">}</span><span class="w"></span>
<span class="w">   </span><span class="n">notification_email_from</span><span class="w"> </span><span class="n">Alexandre</span><span class="p">.</span><span class="n">Cassen</span><span class="nv">@firewall</span><span class="p">.</span><span class="n">loc</span><span class="w"> </span><span class="n">指定发件人</span><span class="w"></span>
<span class="w">   </span><span class="n">smtp_server</span><span class="w"> </span><span class="mf">192.168.200.1</span><span class="w">  </span><span class="n">#指定smtp服务器地址</span><span class="w"></span>
<span class="w">   </span><span class="n">smtp_connect_timeout</span><span class="w"> </span><span class="mi">30</span><span class="w">    </span><span class="n">指定smtp连接超时时间</span><span class="w"></span>
<span class="w">   </span><span class="n">router_id</span><span class="w"> </span><span class="n">LVS_DEVEL</span><span class="w">  </span><span class="n">#负载均衡标识</span><span class="err">，</span><span class="n">在局域网内应该是唯一的</span><span class="err">。</span><span class="w"></span>
<span class="w">   </span><span class="n">vrrp_skip_check_adv_addr</span><span class="w"></span>
<span class="w">   </span><span class="n">vrrp_strict</span><span class="w"></span>
<span class="w">   </span><span class="n">vrrp_garp_interval</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">   </span><span class="n">vrrp_gna_interval</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">说明</span><span class="err">：</span><span class="w"></span>
<span class="n">notification_email</span><span class="err">：</span><span class="n">指定当keepalived出现问题时</span><span class="err">，</span><span class="n">发送邮件给哪些用户</span><span class="err">。</span><span class="w"></span>
<span class="n">notification_emai_from</span><span class="err">：</span><span class="n">发送邮件时</span><span class="err">，</span><span class="n">邮件的来源地址</span><span class="err">。</span><span class="w"></span>
<span class="n">smtp_server</span><span class="w"> </span><span class="o">&lt;</span><span class="k">DOMAIN</span><span class="o">|</span><span class="n">IP</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">&lt;PORT&gt;</span><span class="o">]</span><span class="err">：</span><span class="n">smtp服务器的地址或域名</span><span class="err">。</span><span class="n">默认端口为25</span><span class="p">.</span><span class="n">如</span><span class="err">：</span><span class="n">smtp_server</span><span class="w"> </span><span class="n">smtp</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">com</span><span class="w"> </span><span class="mi">25</span><span class="w"></span>
<span class="n">smtp_helo_name</span><span class="w"> </span><span class="o">&lt;</span><span class="nf">HOST_NAME</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定在HELO消息中所使用的名称</span><span class="err">。</span><span class="n">默认为本地主机名</span><span class="err">。</span><span class="w"></span>
<span class="n">smtp_connect_timeout</span><span class="err">：</span><span class="n">指定smtp服务器连接的超时时间</span><span class="err">。</span><span class="n">单位是秒</span><span class="err">。</span><span class="w"></span>

<span class="n">router_id</span><span class="err">：</span><span class="n">指定标识该机器的route_id</span><span class="p">.</span><span class="w"> </span><span class="n">如</span><span class="err">：</span><span class="n">route_id</span><span class="w"> </span><span class="n">LVS_01</span><span class="w"></span>
<span class="n">vrrp_mcast_group4</span><span class="w"> </span><span class="mf">224.0.0.18</span><span class="err">：</span><span class="n">指定发送VRRP组播消息使用的IPV4组播地址</span><span class="err">。</span><span class="n">默认是224</span><span class="mf">.0.0.18</span><span class="w"></span>
<span class="n">vrrp_mcast_group6</span><span class="w"> </span><span class="nl">ff02</span><span class="p">:</span><span class="err">:</span><span class="mi">12</span><span class="w"> </span><span class="n">指定发送VRRP组播消息所使用的IPV6组播地址</span><span class="err">。</span><span class="nl">默认是ff02</span><span class="p">:</span><span class="err">:</span><span class="mi">12</span><span class="w"></span>
<span class="n">default_interface</span><span class="w"> </span><span class="n">eth0</span><span class="err">：</span><span class="n">设置静态地址默认绑定的端口</span><span class="err">。</span><span class="n">默认是eth0</span><span class="err">。</span><span class="w"></span>
<span class="n">lvs_sync_daemon</span><span class="w"> </span><span class="o">&lt;</span><span class="n">INTERFACE</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">VRRP_INSTANCE</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">id &lt;SYNC_ID&gt;</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">maxlen &lt;LEN&gt;</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">port &lt;PORT&gt;</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">ttl &lt;TTL&gt;</span><span class="o">]</span><span class="w"> </span><span class="o">[</span><span class="n">group &lt;IP ADDR&gt;</span><span class="o">]</span><span class="w"></span>
<span class="w">    </span><span class="n">设置LVS同步服务的相关内容</span><span class="err">。</span><span class="n">可以同步LVS的状态信息</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">INTERFACE</span><span class="err">：</span><span class="n">指定同步服务绑定的接口</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">VRRP_INSTANCE</span><span class="err">：</span><span class="n">指定同步服务绑定的VRRP实例</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="n">SYNC_ID</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定同步服务所使用的SYNCID</span><span class="err">，</span><span class="n">只有相同的SYNCID才会同步</span><span class="err">。</span><span class="n">范围是0</span><span class="o">-</span><span class="mf">255.</span><span class="w"></span>
<span class="w">    </span><span class="n">maxlen</span><span class="err">：</span><span class="n">指定数据包的最大长度</span><span class="err">。</span><span class="n">范围是1</span><span class="o">-</span><span class="mi">65507</span><span class="w"></span>
<span class="w">    </span><span class="n">port</span><span class="err">：</span><span class="n">指定同步所使用的UDP端口</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="k">group</span><span class="err">：</span><span class="n">指定组播IP地址</span><span class="err">。</span><span class="w"></span>

<span class="n">lvs_flush</span><span class="err">：</span><span class="n">在keepalived启动时</span><span class="err">，</span><span class="n">刷新所有已经存在的LVS配置</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_garp_master_delay</span><span class="w"> </span><span class="mi">10</span><span class="err">：</span><span class="n">当转换为MASTER状态时</span><span class="err">，</span><span class="n">延迟多少秒发送第二组的免费ARP</span><span class="err">。</span><span class="n">默认为5s</span><span class="err">，</span><span class="mi">0</span><span class="n">表示不发送第二组免的免费ARP</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_garp_master_repeat</span><span class="w"> </span><span class="mi">1</span><span class="err">：</span><span class="n">当转换为MASTER状态时</span><span class="err">，</span><span class="n">在一组中一次发送的免费ARP数量</span><span class="err">。</span><span class="n">默认是5</span><span class="p">.</span><span class="w"></span>
<span class="n">vrrp_garp_lower_prio_delay</span><span class="w"> </span><span class="mi">10</span><span class="err">：</span><span class="n">当MASTER收到更低优先级的通告时</span><span class="err">，</span><span class="n">延迟多少秒发送第二组的免费ARP</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_garp_lower_prio_repeat</span><span class="w"> </span><span class="mi">1</span><span class="err">：</span><span class="n">当MASTER收到更低优先级的通告时</span><span class="err">，</span><span class="n">在一组中一次发送的免费ARP数量</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_garp_master_refresh</span><span class="w"> </span><span class="mi">60</span><span class="err">：</span><span class="n">当keepalived成为MASTER以后</span><span class="err">，</span><span class="n">刷新免费ARP的最小时间间隔</span><span class="p">(</span><span class="n">会再次发送免费ARP</span><span class="p">)</span><span class="err">。</span><span class="n">默认是0</span><span class="err">，</span><span class="n">表示不会刷新</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_garp_master_refresh_repeat</span><span class="w"> </span><span class="mi">2</span><span class="err">：</span><span class="w"> </span><span class="n">当keepalived成为MASTER以后</span><span class="err">，</span><span class="n">每次刷新会发送多少个免费ARP</span><span class="err">。</span><span class="n">默认是1</span><span class="p">.</span><span class="w"></span>
<span class="n">vrrp_garp_interval</span><span class="w"> </span><span class="mf">0.001</span><span class="err">：</span><span class="n">在一个接口发送的两个免费ARP之间的延迟</span><span class="err">。</span><span class="n">可以精确到毫秒级</span><span class="err">。</span><span class="n">默认是0</span><span class="p">.</span><span class="w"></span>
<span class="n">vrrp_lower_prio_no_advert</span><span class="w"> </span><span class="k">true</span><span class="o">|</span><span class="k">false</span><span class="err">：</span><span class="n">默认是false</span><span class="err">。</span><span class="n">如果收到低优先级的通告</span><span class="err">，</span><span class="n">不发送任何通告</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_version</span><span class="w"> </span><span class="mi">2</span><span class="o">|</span><span class="mi">3</span><span class="err">：</span><span class="n">设置默认的VRRP版本</span><span class="err">。</span><span class="n">默认是2</span><span class="p">.</span><span class="w"></span>
<span class="n">vrrp_check_unicast_src</span><span class="err">：</span><span class="n">在单播模式中</span><span class="err">，</span><span class="n">开启对VRRP数据包的源地址做检查</span><span class="err">，</span><span class="n">源地址必须是单播邻居之一</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_skip_check_adv_addr</span><span class="err">：</span><span class="n">默认是不跳过检查</span><span class="err">。</span><span class="n">检查收到的VRRP通告中的所有地址可能会比较耗时</span><span class="err">，</span><span class="n">设置此命令的意思是</span><span class="err">，</span><span class="n">如果通告与接收的上一个通告来自相同的master路由器</span><span class="err">，</span><span class="n">则不执行检查</span><span class="p">(</span><span class="n">跳过检查</span><span class="p">)</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_strict</span><span class="err">：</span><span class="n">严格遵守VRRP协议</span><span class="err">。</span><span class="n">下列情况将会阻止启动Keepalived</span><span class="err">：</span><span class="mf">1.</span><span class="w"> </span><span class="n">没有VIP地址</span><span class="err">。</span><span class="mf">2.</span><span class="w"> </span><span class="n">单播邻居</span><span class="err">。</span><span class="mf">3.</span><span class="w"> </span><span class="n">在VRRP版本2中有IPv6地址</span><span class="err">。</span><span class="w"></span>

<span class="n">vrrp_iptables</span><span class="err">：</span><span class="n">不添加任何iptables规则</span><span class="err">。</span><span class="n">默认是添加iptables规则的</span><span class="err">。</span><span class="w"></span>

<span class="n">如果vrrp进程或check进程超时</span><span class="err">，</span><span class="n">可以用下面的4个选项</span><span class="err">。</span><span class="n">可以使处于BACKUP状态的VRRP实例变成MASTER状态</span><span class="err">，</span><span class="n">即使MASTER实例依然在运行</span><span class="err">。</span><span class="n">因为MASTER或BACKUP系统比较慢</span><span class="err">，</span><span class="n">不能及时处理VRRP数据包</span><span class="err">。</span><span class="w"></span>
<span class="n">vrrp_priority</span><span class="w"> </span><span class="o">&lt;-</span><span class="mi">20</span><span class="w"> </span><span class="c1">-- 19&gt;：设置VRRP进程的优先级。</span>
<span class="n">checker_priority</span><span class="w"> </span><span class="o">&lt;-</span><span class="mi">20</span><span class="w"> </span><span class="c1">-- 19&gt;：设置checker进程的优先级。</span>
<span class="n">vrrp_no_swap</span><span class="err">：</span><span class="n">vrrp进程不能够被交换</span><span class="err">。</span><span class="w"></span>
<span class="n">checker_no_swap</span><span class="err">：</span><span class="n">checker进程不能够被交换</span><span class="err">。</span><span class="w"></span>

<span class="n">script_user</span><span class="w"> </span><span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">groupname</span><span class="o">]</span><span class="err">：</span><span class="n">设置运行脚本默认用户和组</span><span class="err">。</span><span class="n">如果没有指定</span><span class="err">，</span><span class="n">则默认用户为keepalived_script</span><span class="p">(</span><span class="n">需要该用户存在</span><span class="p">)</span><span class="err">，</span><span class="n">否则为root用户</span><span class="err">。</span><span class="n">默认groupname同username</span><span class="err">。</span><span class="w"></span>
<span class="n">enable_script_security</span><span class="err">：</span><span class="n">如果脚本路径的任一部分对于非root用户来说</span><span class="err">，</span><span class="n">都具有可写权限</span><span class="err">，</span><span class="n">则不会以root身份运行脚本</span><span class="err">。</span><span class="w"></span>
<span class="n">nopreempt</span><span class="w"> </span><span class="n">默认是抢占模式</span><span class="w"> </span><span class="n">要是用非抢占式的就加上nopreempt</span><span class="w"></span>
<span class="n">注意</span><span class="err">：</span><span class="n">上述为global_defs中的指令</span><span class="w"></span>
</pre></div>

<h2 id="vrrpd">VRRPD配置包含如下子块<a class="headerlink" href="#vrrpd" title="Permanent link">&para;</a></h2>
<ol>
<li>vrrp_script</li>
<li>vrrp_sync_group</li>
<li>vrrp_instance</li>
</ol>
<div class="codehilite"><pre><span></span><span class="n">作用</span><span class="err">：</span><span class="n">添加一个周期性执行的脚本</span><span class="err">。</span><span class="n">脚本的退出状态码会被调用它的所有的VRRP</span><span class="w"> </span><span class="n">Instance记录</span><span class="err">。</span><span class="w"></span>
<span class="n">注意</span><span class="err">：</span><span class="n">至少有一个VRRP实例调用它并且优先级不能为0</span><span class="p">.</span><span class="n">优先级范围是1</span><span class="o">-</span><span class="mf">254.</span><span class="w"></span>
<span class="n">vrrp_script</span><span class="w"> </span><span class="o">&lt;</span><span class="n">SCRIPT_NAME</span><span class="o">&gt;</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">          </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="err">}</span><span class="w"></span>

<span class="n">选项说明</span><span class="err">：</span><span class="w"></span>
<span class="n">scrip</span><span class="w"> </span><span class="ss">&quot;/path/to/somewhere&quot;</span><span class="err">：</span><span class="n">指定要执行的脚本的路径</span><span class="err">。</span><span class="w"></span>
<span class="k">interval</span><span class="w"> </span><span class="o">&lt;</span><span class="k">INTEGER</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定脚本执行的间隔</span><span class="err">。</span><span class="n">单位是秒</span><span class="err">。</span><span class="n">默认为1s</span><span class="err">。</span><span class="w"></span>
<span class="n">timeout</span><span class="w"> </span><span class="o">&lt;</span><span class="k">INTEGER</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定在多少秒后</span><span class="err">，</span><span class="n">脚本被认为执行失败</span><span class="err">。</span><span class="w"></span>
<span class="n">weight</span><span class="w"> </span><span class="o">&lt;-</span><span class="mi">254</span><span class="w"> </span><span class="c1">--- 254&gt;：调整优先级。默认为2.</span>
<span class="n">rise</span><span class="w"> </span><span class="o">&lt;</span><span class="k">INTEGER</span><span class="o">&gt;</span><span class="err">：</span><span class="n">执行成功多少次才认为是成功</span><span class="err">。</span><span class="w"></span>
<span class="n">fall</span><span class="w"> </span><span class="o">&lt;</span><span class="k">INTEGER</span><span class="o">&gt;</span><span class="err">：</span><span class="n">执行失败多少次才认为失败</span><span class="err">。</span><span class="w"></span>
<span class="k">user</span><span class="w"> </span><span class="o">&lt;</span><span class="n">USERNAME</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">GROUPNAME</span><span class="o">]</span><span class="err">：</span><span class="n">运行脚本的用户和组</span><span class="err">。</span><span class="w"></span>
<span class="n">init_fail</span><span class="err">：</span><span class="n">假设脚本初始状态是失败状态</span><span class="err">。</span><span class="w"></span>

<span class="n">解释</span><span class="err">：</span><span class="w"></span>
<span class="n">weight</span><span class="err">：</span><span class="w"></span>
<span class="mf">1.</span><span class="w"> </span><span class="n">如果脚本执行成功</span><span class="p">(</span><span class="n">退出状态码为0</span><span class="p">)</span><span class="err">，</span><span class="n">weight大于0</span><span class="err">，</span><span class="n">则priority增加</span><span class="err">。</span><span class="w"></span>
<span class="mf">2.</span><span class="w"> </span><span class="n">如果脚本执行失败</span><span class="p">(</span><span class="n">退出状态码为非0</span><span class="p">)</span><span class="err">，</span><span class="n">weight小于0</span><span class="err">，</span><span class="n">则priority减少</span><span class="err">。</span><span class="w"></span>
<span class="mf">3.</span><span class="w"> </span><span class="n">其他情况下</span><span class="err">，</span><span class="n">priority不变</span><span class="err">。</span><span class="w"></span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="n">作用</span><span class="err">：</span><span class="n">将所有相关的VRRP实例定义在一起</span><span class="err">，</span><span class="n">作为一个VRRP</span><span class="w"> </span><span class="k">Group</span><span class="err">，</span><span class="n">如果组内的任意一个实例出现问题</span><span class="err">，</span><span class="n">都可以实现Failover</span><span class="err">。</span><span class="w"></span>
<span class="w"> </span><span class="n">vrrp_sync_group</span><span class="w"> </span><span class="n">VG_1</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">     </span><span class="n">inside_network</span><span class="w">     </span><span class="err">#</span><span class="w"> </span><span class="n">vrrp</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="n">name</span><span class="w"></span>
<span class="w">     </span><span class="n">outside_network</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">vrrp</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="n">name</span><span class="w"></span>
<span class="w">     </span><span class="p">...</span><span class="w"></span>
<span class="w">    </span><span class="err">}</span><span class="w"></span>
<span class="w">    </span><span class="p">...</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">说明</span><span class="err">：</span><span class="w"></span>
<span class="n">如果username和groupname没有指定</span><span class="err">，</span><span class="n">则以默认的script_user所指定的用户和组</span><span class="err">。</span><span class="w"></span>
<span class="mf">1.</span><span class="w"> </span><span class="n">notify_master</span><span class="w"> </span><span class="o">/</span><span class="k">path</span><span class="o">/</span><span class="n">to_master</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="w">    </span><span class="n">作用</span><span class="err">：</span><span class="n">当成为MASTER时</span><span class="err">，</span><span class="n">以指定的用户和组执行脚本</span><span class="err">。</span><span class="w"></span>
<span class="mf">2.</span><span class="w"> </span><span class="n">notify_backup</span><span class="w"> </span><span class="o">/</span><span class="k">path</span><span class="o">/</span><span class="n">to_backup</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="w">    </span><span class="n">作用</span><span class="err">：</span><span class="n">当成为BACKUP时</span><span class="err">，</span><span class="n">以指定的用户和组执行脚本</span><span class="err">。</span><span class="w"></span>
<span class="mf">3.</span><span class="w"> </span><span class="n">notify_fault</span><span class="w"> </span><span class="ss">&quot;/path/fault.sh VG_1&quot;</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="w">    </span><span class="n">作用</span><span class="err">：</span><span class="n">当该同步组Fault时</span><span class="err">，</span><span class="n">以指定的用户和组执行脚本</span><span class="err">。</span><span class="w"></span>
<span class="mf">4.</span><span class="w"> </span><span class="n">notify</span><span class="w"> </span><span class="o">/</span><span class="k">path</span><span class="o">/</span><span class="n">notify</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="w">    </span><span class="n">作用</span><span class="err">：</span><span class="n">在任何状态都会以指定的用户和组执行脚本</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">说明</span><span class="err">：</span><span class="n">该脚本会在notify_</span><span class="o">*</span><span class="n">脚本后执行</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="n">notify可以使用3个参数</span><span class="err">，</span><span class="n">如下</span><span class="err">：</span><span class="w"></span>
<span class="w">    </span><span class="err">$</span><span class="mi">1</span><span class="err">：</span><span class="n">可以是GROUP或INTANCE</span><span class="err">，</span><span class="n">表明后面是组还是实例</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="err">$</span><span class="mi">2</span><span class="err">：</span><span class="n">组名或实例名</span><span class="err">。</span><span class="w"></span>
<span class="w">    </span><span class="err">$</span><span class="mi">3</span><span class="err">：</span><span class="n">转换后的目标状态</span><span class="err">。</span><span class="n">有</span><span class="err">：</span><span class="n">MASTER</span><span class="err">、</span><span class="k">BACKUP</span><span class="err">、</span><span class="n">FAULT</span><span class="err">。</span><span class="w"></span>

<span class="mf">5.</span><span class="w"> </span><span class="n">smtp_alert</span><span class="err">：</span><span class="n">当状态发生改变时</span><span class="err">，</span><span class="n">发送邮件</span><span class="err">。</span><span class="w"></span>
<span class="mf">6.</span><span class="w"> </span><span class="n">global_tracking</span><span class="err">：</span><span class="n">所有的VRRP实例共享相同的tracking配置</span><span class="err">。</span><span class="w"></span>

<span class="n">注意</span><span class="err">：</span><span class="n">脚本文件要加上x权限</span><span class="err">，</span><span class="n">同时指令最好写绝对路径</span><span class="err">。</span><span class="w"></span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="n">命令说明</span><span class="err">：</span><span class="w"></span>
<span class="k">state</span><span class="w"> </span><span class="n">MASTER</span><span class="o">|</span><span class="k">BACKUP</span><span class="err">：</span><span class="n">指定该keepalived节点的初始状态</span><span class="err">。</span><span class="w"></span>
<span class="n">interface</span><span class="w"> </span><span class="n">eth0</span><span class="err">：</span><span class="n">vrrp实例绑定的接口</span><span class="err">，</span><span class="n">用于发送VRRP包</span><span class="err">。</span><span class="w"></span>
<span class="n">use_vmac</span><span class="w"> </span><span class="o">[</span><span class="n">&lt;VMAC_INTERFACE&gt;</span><span class="o">]</span><span class="err">：</span><span class="n">在指定的接口产生一个子接口</span><span class="err">，</span><span class="n">如vrrp</span><span class="mf">.51</span><span class="err">，</span><span class="n">该接口的MAC地址为组播地址</span><span class="err">，</span><span class="n">通过该接口向外发送和接收VRRP包</span><span class="err">。</span><span class="w"></span>
<span class="n">vmac_xmit_base</span><span class="err">：</span><span class="n">通过基本接口向外发送和接收VRRP数据包</span><span class="err">，</span><span class="n">而不是通过VMAC接口</span><span class="err">。</span><span class="w"></span>
<span class="n">native_ipv6</span><span class="err">：</span><span class="n">强制VRRP实例使用IPV6</span><span class="p">.(</span><span class="n">当同时配置了IPV4和IPV6的时候</span><span class="p">)</span><span class="w"></span>
<span class="n">dont_track_primary</span><span class="err">：</span><span class="n">忽略VRRP接口的错误</span><span class="err">，</span><span class="n">默认是没有配置的</span><span class="err">。</span><span class="w"></span>

<span class="n">track_interface</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="n">eth0</span><span class="w"></span>
<span class="w">  </span><span class="n">eth1</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">&lt;-</span><span class="mi">254</span><span class="o">-</span><span class="mi">254</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="p">...</span><span class="w"></span>
<span class="err">}：</span><span class="n">如果track的接口有任何一个出现故障</span><span class="err">，</span><span class="n">都会进入FAULT状态</span><span class="err">。</span><span class="w"></span>

<span class="n">track_script</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">SCRIPT_NAME</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">SCRIPT_NAME</span><span class="o">&gt;</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">&lt;-</span><span class="mi">254</span><span class="o">-</span><span class="mi">254</span><span class="o">&gt;</span><span class="w"></span>
<span class="err">}：</span><span class="n">添加一个track脚本</span><span class="p">(</span><span class="n">vrrp_script配置的脚本</span><span class="err">。</span><span class="p">)</span><span class="w"></span>

<span class="n">mcast_src_ip</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IPADDR</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定发送组播数据包的源IP地址</span><span class="err">。</span><span class="n">默认是绑定VRRP实例的接口的主IP地址</span><span class="err">。</span><span class="w"></span>
<span class="n">unicast_src_ip</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IPADDR</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定发送单薄数据包的源IP地址</span><span class="err">。</span><span class="n">默认是绑定VRRP实例的接口的主IP地址</span><span class="err">。</span><span class="w"></span>
<span class="n">version</span><span class="w"> </span><span class="mi">2</span><span class="o">|</span><span class="mi">3</span><span class="err">：</span><span class="n">指定该实例所使用的VRRP版本</span><span class="err">。</span><span class="w"></span>

<span class="n">unicast_peer</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">   </span><span class="o">&lt;</span><span class="n">IPADDR</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">   </span><span class="p">...</span><span class="w"></span>
<span class="err">}：</span><span class="n">采用单播的方式发送VRRP通告</span><span class="err">，</span><span class="n">指定单播邻居的IP地址</span><span class="err">。</span><span class="w"></span>

<span class="n">virtual_router_id</span><span class="w"> </span><span class="mi">51</span><span class="err">：</span><span class="n">指定VRRP实例ID</span><span class="err">，</span><span class="n">范围是0</span><span class="o">-</span><span class="mf">255.</span><span class="w"></span>
<span class="n">priority</span><span class="w"> </span><span class="mi">100</span><span class="err">：</span><span class="n">指定优先级</span><span class="err">，</span><span class="n">优先级高的将成为MASTER</span><span class="err">。</span><span class="w"></span>
<span class="n">advert_int</span><span class="w"> </span><span class="mi">1</span><span class="err">：</span><span class="n">指定发送VRRP通告的间隔</span><span class="err">。</span><span class="n">单位是秒</span><span class="err">。</span><span class="w"></span>
<span class="n">authentication</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="n">auth_type</span><span class="w"> </span><span class="n">PASS</span><span class="o">|</span><span class="n">AH</span><span class="err">：</span><span class="n">指定认证方式</span><span class="err">。</span><span class="n">PASS简单密码认证</span><span class="p">(</span><span class="n">推荐</span><span class="p">),</span><span class="nl">AH</span><span class="p">:</span><span class="n">IPSEC认证</span><span class="p">(</span><span class="n">不推荐</span><span class="p">)</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">auth_pass</span><span class="w"> </span><span class="mi">1234</span><span class="err">：</span><span class="n">指定认证所使用的密码</span><span class="err">。</span><span class="n">最多8位</span><span class="err">。</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">virtual_ipaddress</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">   </span><span class="o">&lt;</span><span class="n">IPADDR</span><span class="o">&gt;/&lt;</span><span class="n">MASK</span><span class="o">&gt;</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IPADDR</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="o">&lt;</span><span class="k">SCOPE</span><span class="o">&gt;</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">&lt;</span><span class="n">LABEL</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">   </span><span class="mf">192.168.200.17</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="n">eth1</span><span class="w"></span>
<span class="w">   </span><span class="mf">192.168.200.18</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">dev</span><span class="w"> </span><span class="n">eth2</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="nl">eth2</span><span class="p">:</span><span class="mi">1</span><span class="w"></span>
<span class="err">}：</span><span class="n">指定VIP地址</span><span class="err">。</span><span class="w"></span>

<span class="n">nopreempt</span><span class="err">：</span><span class="n">设置为不抢占</span><span class="err">。</span><span class="n">默认是抢占的</span><span class="err">，</span><span class="n">当高优先级的机器恢复后</span><span class="err">，</span><span class="n">会抢占低优先级的机器成为MASTER</span><span class="err">，</span><span class="n">而不抢占</span><span class="err">，</span><span class="n">则允许低优先级的机器继续成为MASTER</span><span class="err">，</span><span class="n">即使高优先级的机器已经上线</span><span class="err">。</span><span class="n">如果要使用这个功能</span><span class="err">，</span><span class="n">则初始化状态必须为BACKUP</span><span class="err">。</span><span class="w"></span>
<span class="n">preempt_delay</span><span class="err">：</span><span class="n">设置抢占延迟</span><span class="err">。</span><span class="n">单位是秒</span><span class="err">，</span><span class="n">范围是0</span><span class="c1">---1000，默认是0.发现低优先级的MASTER后多少秒开始抢占。</span>


<span class="n">通知脚本</span><span class="err">：</span><span class="w"></span>
<span class="n">notify_master</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;|&lt;</span><span class="n">QUOTED</span><span class="o">-</span><span class="n">STRING</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="n">notify_backup</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;|&lt;</span><span class="n">QUOTED</span><span class="o">-</span><span class="n">STRING</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="n">notify_fault</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;|&lt;</span><span class="n">QUOTED</span><span class="o">-</span><span class="n">STRING</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="n">notify</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;|&lt;</span><span class="n">QUOTED</span><span class="o">-</span><span class="n">STRING</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">当停止VRRP时执行的脚本</span><span class="err">。</span><span class="w"></span>
<span class="n">notify_stop</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;|&lt;</span><span class="n">QUOTED</span><span class="o">-</span><span class="n">STRING</span><span class="o">&gt;</span><span class="w"> </span><span class="o">[</span><span class="n">username [groupname</span><span class="o">]</span><span class="err">]</span><span class="w"></span>
<span class="n">smtp_alert</span><span class="w"></span>
</pre></div>

<h2 id="lvs">LVS配置<a class="headerlink" href="#lvs" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="n">virtual_server</span> <span class="n">IP</span> <span class="n">Port</span> <span class="o">|</span> <span class="n">virtual_server</span> <span class="n">fwmark</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">virtual_server</span> <span class="k">group</span> <span class="n">string</span> <span class="err">{</span>
  <span class="n">delay_loop</span> <span class="o">&lt;</span><span class="nb">INT</span><span class="o">&gt;</span><span class="err">：健康检查的时间间隔。</span>
  <span class="n">lb_argo</span> <span class="n">rr</span><span class="o">|</span><span class="n">wrr</span><span class="o">|</span><span class="n">lc</span><span class="o">|</span><span class="n">wlc</span><span class="o">|</span><span class="n">lblc</span><span class="o">|</span><span class="n">sh</span><span class="o">|</span><span class="n">dh</span><span class="err">：</span><span class="n">LVS调度算法</span><span class="err">。</span>
  <span class="n">lb_kind</span> <span class="n">NAT</span><span class="o">|</span><span class="n">DR</span><span class="o">|</span><span class="n">TUN</span><span class="err">：</span><span class="n">LVS模式</span><span class="err">。</span>
  <span class="n">persistence_timeout</span> <span class="mi">360</span><span class="err">：持久化超时时间，单位是秒。默认是</span><span class="mi">6</span><span class="err">分钟。</span>
  <span class="n">persistence_granularity</span><span class="err">：持久化连接的颗粒度。</span>
  <span class="n">protocol</span> <span class="n">TCP</span><span class="o">|</span><span class="n">UDP</span><span class="o">|</span><span class="n">SCTP</span><span class="err">：</span><span class="mi">4</span><span class="err">层协议。</span>
  <span class="n">ha_suspend</span><span class="err">：如果</span><span class="n">virtual</span> <span class="n">server的IP地址没有设置</span><span class="err">，则不进行后端服务器的健康检查。</span>
  <span class="n">virtualhost</span> <span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：为</span><span class="n">HTTP_GET和SSL_GET执行要检查的虚拟主机</span><span class="err">。如</span><span class="n">virtualhost</span> <span class="n">www</span><span class="p">.</span><span class="n">felix</span><span class="p">.</span><span class="n">com</span>
  <span class="n">sorry_server</span> <span class="o">&lt;</span><span class="n">IPADDR</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：添加一个备用服务器。当所有的</span><span class="n">RS都故障时</span><span class="err">。</span>
  <span class="n">sorry_server_inhibit</span><span class="err">：将</span><span class="n">inhibit_on_failure指令应用于sorry_server指令</span><span class="err">。</span>

  <span class="n">alpha</span><span class="err">：在</span><span class="n">keepalived启动时</span><span class="err">，假设所有的</span><span class="n">RS都是down</span><span class="err">，以及健康检查是失败的。有助于防止启动时的误报。默认是禁用的。</span>
  <span class="n">omega</span><span class="err">：在</span><span class="n">keepalived终止时</span><span class="err">，会执行</span><span class="n">quorum_down指令所定义的脚本</span><span class="err">。</span>

  <span class="n">quorum</span> <span class="o">&lt;</span><span class="nb">INT</span><span class="o">&gt;</span><span class="err">：默认值</span><span class="mi">1</span><span class="p">.</span> <span class="err">所有的存活的服务器的总的最小权重。</span>
  <span class="n">quorum_up</span> <span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：当</span><span class="n">quorum增长到满足quorum所定义的值时</span><span class="err">，执行该脚本。</span>
  <span class="n">quorum_down</span> <span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：当</span><span class="n">quorum减少到不满足quorum所定义的值时</span><span class="err">，执行该脚本。</span>
<span class="err">}</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="n">real_server</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">Port</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="n">weight</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">给服务器指定权重</span><span class="err">。</span><span class="n">默认是1</span><span class="p">.</span><span class="w"></span>
<span class="w">  </span><span class="n">inhibit_on_failure</span><span class="err">：</span><span class="n">当服务器健康检查失败时</span><span class="err">，</span><span class="n">将其weight设置为0</span><span class="err">，</span><span class="n">而不是从Virtual</span><span class="w"> </span><span class="n">Server中移除</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">notify_up</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：</span><span class="n">当服务器健康检查成功时</span><span class="err">，</span><span class="n">执行的脚本</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">notify_down</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：</span><span class="n">当服务器健康检查失败时</span><span class="err">，</span><span class="n">执行的脚本</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">uthreshold</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">到这台服务器的最大连接数</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="n">lthreshold</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">到这台服务器的最小连接数</span><span class="err">。</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="err">#</span><span class="w"> </span><span class="n">real_server中的健康检查</span><span class="w"></span>
<span class="n">HTTP_GET</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SSL_GET</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="n">url</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w">  </span><span class="k">path</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定要检查的URL的路径</span><span class="err">。</span><span class="n">如path</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">path</span><span class="w"> </span><span class="o">/</span><span class="n">mrtg2</span><span class="w"></span>
<span class="w">  </span><span class="n">digest</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：</span><span class="n">摘要</span><span class="err">。</span><span class="n">计算方式</span><span class="err">：</span><span class="n">genhash</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="mf">172.17.100.1</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">80</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="o">/</span><span class="k">index</span><span class="p">.</span><span class="n">html</span><span class="w"></span>
<span class="w">  </span><span class="n">status_code</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">状态码</span><span class="err">。</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
<span class="n">nb_get_retry</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">get尝试次数</span><span class="err">。</span><span class="w"></span>
<span class="n">delay_before_retry</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">在尝试之前延迟多长时间</span><span class="err">。</span><span class="w"></span>

<span class="n">connect_ip</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IP</span><span class="w"> </span><span class="n">ADDRESS</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接的IP地址</span><span class="err">。</span><span class="n">默认是real</span><span class="w"> </span><span class="n">server的ip地址</span><span class="err">。</span><span class="w"></span>
<span class="n">connect_port</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接的端口</span><span class="err">。</span><span class="n">默认是real</span><span class="w"> </span><span class="n">server的端口</span><span class="err">。</span><span class="w"></span>
<span class="n">bindto</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IP</span><span class="w"> </span><span class="n">ADDRESS</span><span class="o">&gt;</span><span class="err">：</span><span class="n">发起连接的接口的地址</span><span class="err">。</span><span class="w"></span>
<span class="n">bind_port</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">发起连接的源端口</span><span class="err">。</span><span class="w"></span>
<span class="n">connect_timeout</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接超时时间</span><span class="err">。</span><span class="n">默认是5s</span><span class="err">。</span><span class="w"></span>
<span class="n">fwmark</span><span class="w"> </span><span class="o">&lt;</span><span class="k">INTEGER</span><span class="o">&gt;</span><span class="err">：</span><span class="n">使用fwmark对所有出去的检查数据包进行标记</span><span class="err">。</span><span class="w"></span>
<span class="n">warmup</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定一个随机延迟</span><span class="err">，</span><span class="n">最大为N秒</span><span class="err">。</span><span class="n">可防止网络阻塞</span><span class="err">。</span><span class="n">如果为0</span><span class="err">，</span><span class="n">则关闭该功能</span><span class="err">。</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>

<span class="n">TCP_CHECK</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="n">connect_ip</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IP</span><span class="w"> </span><span class="n">ADDRESS</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接的IP地址</span><span class="err">。</span><span class="n">默认是real</span><span class="w"> </span><span class="n">server的ip地址</span><span class="err">。</span><span class="w"></span>
<span class="n">connect_port</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接的端口</span><span class="err">。</span><span class="n">默认是real</span><span class="w"> </span><span class="n">server的端口</span><span class="err">。</span><span class="w"></span>
<span class="n">bindto</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IP</span><span class="w"> </span><span class="n">ADDRESS</span><span class="o">&gt;</span><span class="err">：</span><span class="n">发起连接的接口的地址</span><span class="err">。</span><span class="w"></span>
<span class="n">bind_port</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">发起连接的源端口</span><span class="err">。</span><span class="w"></span>
<span class="n">connect_timeout</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接超时时间</span><span class="err">。</span><span class="n">默认是5s</span><span class="err">。</span><span class="w"></span>
<span class="n">fwmark</span><span class="w"> </span><span class="o">&lt;</span><span class="k">INTEGER</span><span class="o">&gt;</span><span class="err">：</span><span class="n">使用fwmark对所有出去的检查数据包进行标记</span><span class="err">。</span><span class="w"></span>
<span class="n">warmup</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定一个随机延迟</span><span class="err">，</span><span class="n">最大为N秒</span><span class="err">。</span><span class="n">可防止网络阻塞</span><span class="err">。</span><span class="n">如果为0</span><span class="err">，</span><span class="n">则关闭该功能</span><span class="err">。</span><span class="w"></span>
<span class="n">retry</span><span class="w"> </span><span class="o">&lt;</span><span class="n">INIT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">重试次数</span><span class="err">。</span><span class="n">默认是1次</span><span class="err">。</span><span class="w"></span>
<span class="n">delay_before_retry</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">默认是1秒</span><span class="err">。</span><span class="n">在重试之前延迟多少秒</span><span class="err">。</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>


<span class="n">SMTP_CHECK</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="n">connect_ip</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IP</span><span class="w"> </span><span class="n">ADDRESS</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接的IP地址</span><span class="err">。</span><span class="n">默认是real</span><span class="w"> </span><span class="n">server的ip地址</span><span class="err">。</span><span class="w"></span>
<span class="n">connect_port</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接的端口</span><span class="err">。</span><span class="n">默认是real</span><span class="w"> </span><span class="n">server的端口</span><span class="err">。</span><span class="w"> </span><span class="n">默认是25端口</span><span class="w"></span>
<span class="n">bindto</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IP</span><span class="w"> </span><span class="n">ADDRESS</span><span class="o">&gt;</span><span class="err">：</span><span class="n">发起连接的接口的地址</span><span class="err">。</span><span class="w"></span>
<span class="n">bind_port</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">发起连接的源端口</span><span class="err">。</span><span class="w"></span>
<span class="n">connect_timeout</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接超时时间</span><span class="err">。</span><span class="n">默认是5s</span><span class="err">。</span><span class="w"></span>
<span class="n">fwmark</span><span class="w"> </span><span class="o">&lt;</span><span class="k">INTEGER</span><span class="o">&gt;</span><span class="err">：</span><span class="n">使用fwmark对所有出去的检查数据包进行标记</span><span class="err">。</span><span class="w"></span>
<span class="n">warmup</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定一个随机延迟</span><span class="err">，</span><span class="n">最大为N秒</span><span class="err">。</span><span class="n">可防止网络阻塞</span><span class="err">。</span><span class="n">如果为0</span><span class="err">，</span><span class="n">则关闭该功能</span><span class="err">。</span><span class="w"></span>

<span class="n">retry</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">重试次数</span><span class="err">。</span><span class="w"></span>
<span class="n">delay_before_retry</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">在重试之前延迟多少秒</span><span class="err">。</span><span class="w"></span>
<span class="n">helo_name</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：</span><span class="n">用于SMTP</span><span class="w"> </span><span class="n">HELO请求的字符串</span><span class="err">。</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>


<span class="n">DNS_CHECK</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="n">connect_ip</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IP</span><span class="w"> </span><span class="n">ADDRESS</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接的IP地址</span><span class="err">。</span><span class="n">默认是real</span><span class="w"> </span><span class="n">server的ip地址</span><span class="err">。</span><span class="w"></span>
<span class="n">connect_port</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接的端口</span><span class="err">。</span><span class="n">默认是real</span><span class="w"> </span><span class="n">server的端口</span><span class="err">。</span><span class="w"> </span><span class="n">默认是25端口</span><span class="w"></span>
<span class="n">bindto</span><span class="w"> </span><span class="o">&lt;</span><span class="n">IP</span><span class="w"> </span><span class="n">ADDRESS</span><span class="o">&gt;</span><span class="err">：</span><span class="n">发起连接的接口的地址</span><span class="err">。</span><span class="w"></span>
<span class="n">bind_port</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PORT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">发起连接的源端口</span><span class="err">。</span><span class="w"></span>
<span class="n">connect_timeout</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">连接超时时间</span><span class="err">。</span><span class="n">默认是5s</span><span class="err">。</span><span class="w"></span>
<span class="n">fwmark</span><span class="w"> </span><span class="o">&lt;</span><span class="k">INTEGER</span><span class="o">&gt;</span><span class="err">：</span><span class="n">使用fwmark对所有出去的检查数据包进行标记</span><span class="err">。</span><span class="w"></span>
<span class="n">warmup</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定一个随机延迟</span><span class="err">，</span><span class="n">最大为N秒</span><span class="err">。</span><span class="n">可防止网络阻塞</span><span class="err">。</span><span class="n">如果为0</span><span class="err">，</span><span class="n">则关闭该功能</span><span class="err">。</span><span class="w"></span>

<span class="n">retry</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">重试次数</span><span class="err">。</span><span class="n">默认是3次</span><span class="err">。</span><span class="w"></span>
<span class="n">type</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：</span><span class="n">DNS</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="n">type</span><span class="err">。</span><span class="n">A</span><span class="o">/</span><span class="n">NS</span><span class="o">/</span><span class="n">CNAME</span><span class="o">/</span><span class="n">SOA</span><span class="o">/</span><span class="n">MX</span><span class="o">/</span><span class="n">TXT</span><span class="o">/</span><span class="n">AAAA</span><span class="w"></span>
<span class="n">name</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：</span><span class="n">DNS查询的域名</span><span class="err">。</span><span class="n">默认是</span><span class="p">(.)</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>



<span class="n">MISC_CHECK</span><span class="w"> </span><span class="err">{</span><span class="w"></span>
<span class="w"> </span><span class="n">misc_path</span><span class="w"> </span><span class="o">&lt;</span><span class="n">STRING</span><span class="o">&gt;</span><span class="err">：</span><span class="n">外部的脚本或程序路径</span><span class="err">。</span><span class="w"></span>
<span class="w"> </span><span class="n">misc_timeout</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">脚本执行超时时间</span><span class="err">。</span><span class="w"></span>
<span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="n">USERNAME</span><span class="w"> </span><span class="o">[</span><span class="n">GROUPNAME</span><span class="o">]</span><span class="err">：</span><span class="n">指定运行该脚本的用户和组</span><span class="err">。</span><span class="n">如果没有指定GROUPNAME</span><span class="err">，</span><span class="n">则GROUPNAME同USERNAME</span><span class="err">。</span><span class="w"></span>
<span class="w"> </span><span class="n">misc_dynamic</span><span class="err">：</span><span class="n">根据退出状态码动态调整权重</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="mi">0</span><span class="err">，</span><span class="n">健康检查成功</span><span class="err">，</span><span class="n">权重不变</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="mi">1</span><span class="err">，</span><span class="n">健康检查失败</span><span class="err">。</span><span class="w"></span>
<span class="w">  </span><span class="mi">2</span><span class="o">-</span><span class="mi">255</span><span class="err">，</span><span class="n">健康检查成功</span><span class="err">。</span><span class="n">权重设置为退出状态码减去2</span><span class="p">.</span><span class="n">如退出状态码是250</span><span class="err">，</span><span class="n">则权重调整为248</span><span class="w"></span>
<span class="w">   </span><span class="n">warmup</span><span class="w"> </span><span class="o">&lt;</span><span class="nc">INT</span><span class="o">&gt;</span><span class="err">：</span><span class="n">指定一个随机延迟</span><span class="err">，</span><span class="n">最大为N秒</span><span class="err">。</span><span class="n">可防止网络阻塞</span><span class="err">。</span><span class="n">如果为0</span><span class="err">，</span><span class="n">则关闭该功能</span><span class="err">。</span><span class="w"></span>
<span class="err">}</span><span class="w"></span>
</pre></div>

<h2 id="keepalived_1">修改Keepalived日志<a class="headerlink" href="#keepalived_1" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span># <span class="nv">keepalived</span> 默认将日志输出到系统日志<span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">messages</span>中
<span class="nv">vi</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">sysconfig</span><span class="o">/</span><span class="nv">keepalived</span>

# <span class="nv">Options</span> <span class="k">for</span> <span class="nv">keepalived</span>. <span class="nv">See</span> `<span class="nv">keepalived</span> <span class="o">--</span><span class="nv">help</span><span class="s1">&#39;</span><span class="s">output and keepalived(8) and</span>
# <span class="nv">keepalived</span>.<span class="nv">conf</span><span class="ss">(</span><span class="mi">5</span><span class="ss">)</span> <span class="nv">man</span> <span class="nv">pages</span> <span class="k">for</span> <span class="nv">a</span> <span class="nv">list</span> <span class="nv">of</span> <span class="nv">all</span> <span class="nv">options</span>. <span class="nv">Here</span> <span class="nv">are</span> <span class="nv">the</span> <span class="nv">most</span>
# <span class="nv">common</span> <span class="nv">ones</span> :
#
# <span class="o">--</span><span class="nv">vrrp</span>               <span class="o">-</span><span class="nv">P</span>    <span class="nv">Only</span> <span class="nv">run</span> <span class="nv">with</span> <span class="nv">VRRP</span> <span class="nv">subsystem</span>.
# <span class="o">--</span><span class="nv">check</span>              <span class="o">-</span><span class="nv">C</span>    <span class="nv">Only</span> <span class="nv">run</span> <span class="nv">with</span> <span class="nv">Health</span><span class="o">-</span><span class="nv">checker</span> <span class="nv">subsystem</span>.
# <span class="o">--</span><span class="nv">dont</span><span class="o">-</span><span class="nv">release</span><span class="o">-</span><span class="nv">vrrp</span>  <span class="o">-</span><span class="nv">V</span>    <span class="nv">Dont</span> <span class="nv">remove</span> <span class="nv">VRRP</span> <span class="nv">VIPs</span> <span class="o">&amp;</span> <span class="nv">VROUTEs</span> <span class="nv">on</span> <span class="nv">daemon</span> <span class="nv">stop</span>.
# <span class="o">--</span><span class="nv">dont</span><span class="o">-</span><span class="nv">release</span><span class="o">-</span><span class="nv">ipvs</span>  <span class="o">-</span><span class="nv">I</span>    <span class="nv">Dont</span> <span class="nv">remove</span> <span class="nv">IPVS</span> <span class="nv">topology</span> <span class="nv">on</span> <span class="nv">daemon</span> <span class="nv">stop</span>.
# <span class="o">--</span><span class="nv">dump</span><span class="o">-</span><span class="nv">conf</span>          <span class="o">-</span><span class="nv">d</span>    <span class="nv">Dump</span> <span class="nv">the</span> <span class="nv">configuration</span> <span class="nv">data</span>.
# <span class="o">--</span><span class="nv">log</span><span class="o">-</span><span class="nv">detail</span>         <span class="o">-</span><span class="nv">D</span>    <span class="nv">Detailed</span> <span class="nv">log</span> <span class="nv">messages</span>.
# <span class="o">--</span><span class="nv">log</span><span class="o">-</span><span class="nv">facility</span>       <span class="o">-</span><span class="nv">S</span>    <span class="mi">0</span><span class="o">-</span><span class="mi">7</span> <span class="nv">Set</span> <span class="nv">local</span> <span class="nv">syslog</span> <span class="nv">facility</span> <span class="ss">(</span><span class="nv">default</span><span class="o">=</span><span class="nv">LOG_DAEMON</span><span class="ss">)(</span>日志的级别<span class="ss">)</span>
#

# 把 <span class="nv">KEEPALIVED_OPTIONS</span><span class="o">=</span>”<span class="o">-</span><span class="nv">D</span>” 修改为 <span class="nv">KEEPALIVED_OPTIONS</span><span class="o">=</span>”<span class="o">-</span><span class="nv">D</span> <span class="o">-</span><span class="nv">d</span> <span class="o">-</span><span class="nv">S</span> <span class="mi">0</span>”，其中 <span class="o">-</span><span class="nv">S</span> 指定 <span class="nv">syslog</span> 的 <span class="nv">facility</span>
<span class="nv">KEEPALIVED_OPTIONS</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">-D -d -S 0</span><span class="s2">&quot;</span>

# 修改 <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">rsyslog</span>.<span class="nv">conf</span> 末尾添加
<span class="nv">vi</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">rsyslog</span>.<span class="nv">conf</span>
<span class="nv">local0</span>.<span class="o">*</span>                                                <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">keepalived</span>.<span class="nv">log</span>

# 重启日志记录服务
<span class="nv">systemctl</span> <span class="nv">restart</span> <span class="nv">rsyslog</span>

# 重启 <span class="nv">keepalived</span>
<span class="nv">systemctl</span> <span class="nv">restart</span> <span class="nv">keepalived</span>

日志级别：指定触发日志事件的级别
</pre></div>

<h2 id="lvs-natkeepalived">LVS-NAT+Keepalived主从部署示例<a class="headerlink" href="#lvs-natkeepalived" title="Permanent link">&para;</a></h2>
<p>LVS-DR修改virtual_server下lb_kind NAT参数为lb_kind DR(LVS-DR为常用方式)</p>
<table>
<thead>
<tr>
<th align="center">IP地址</th>
<th align="center">主机名</th>
<th align="center">类型</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">1.1.1.10</td>
<td align="center">LVS-Master</td>
<td align="center">VIP</td>
</tr>
<tr>
<td align="center">192.168.1.10</td>
<td align="center">LVS-Master</td>
<td align="center">DIP</td>
</tr>
<tr>
<td align="center">1.1.1.20</td>
<td align="center">LVS-Backup</td>
<td align="center">VIP</td>
</tr>
<tr>
<td align="center">192.168.1.20</td>
<td align="center">LVS-Backup</td>
<td align="center">DIP</td>
</tr>
<tr>
<td align="center">192.168.1.100</td>
<td align="center">Web-node1</td>
<td align="center">realserver1</td>
</tr>
<tr>
<td align="center">192.168.1.200</td>
<td align="center">Web-node2</td>
<td align="center">realserver2</td>
</tr>
<tr>
<td align="center">1.1.1.131</td>
<td align="center">client</td>
<td align="center">client</td>
</tr>
</tbody>
</table>
<p>公网浮动IP：1.1.1.1
内网浮动IP：192.168.1.1</p>
<p>eth0:1.1.1.10   ___________            ___________
VIP            |           |         |           |<br />
               | LVS-Master|—— —— —— —| Web-node1 |192.168.1.100
               |___________|       <strong>/|_________</strong>|
eth1:192.168.1.10  |               /|
DIP                |              /
 ________          |             /
|        |         |            \/
| client |—— —— —— —            /\
|________|         |           /  \
                   |          /    \
                   |         /      \
eth0:1.1.1.20   <strong><em>|____</em></strong> /       <em>\/__________</em>
VIP            |           |         |           |
               | LVS-Backup|—— —— —— —| Web-node2 |192.168.1.200
DIP            |___________|         /|___________|
eth1:192.168.1.20</p>
<h2 id="lvsip">LVS服务器上配置IP<a class="headerlink" href="#lvsip" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>vim /etc/sysconfig/network-scripts/ifcfg-eth0
vim /etc/sysconfig/network-scripts/ifcfg-eth1

<span class="c1"># 修改内核参数</span>
vim /etc/sysctl.conf
net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span>
net.ipv4.conf.all.send_redirects <span class="o">=</span> <span class="m">0</span>
net.ipv4.conf.default.send_redirects <span class="o">=</span> <span class="m">0</span>
net.ipv4.conf.eth0.send_redirects <span class="o">=</span> <span class="m">0</span>
sysctl -p

<span class="c1"># realserver分别执行以下命令</span>
<span class="c1"># 绑定vip(centos6)</span>
ifconfig lo:0 <span class="m">1</span>.1.1.1 netmask <span class="m">255</span>.255.255.255 broadcast <span class="m">1</span>.1.1.1
<span class="c1"># (centos7)</span>
ip a a <span class="m">1</span>.1.1.1/24 dev lo:0

<span class="c1"># arp抑制</span>
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore
<span class="nb">echo</span> <span class="s2">&quot;2&quot;</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce
<span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore
<span class="nb">echo</span> <span class="s2">&quot;2&quot;</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce
<span class="c1"># arp_ignore:定义接收到ARP请求时的响应级别</span>
<span class="m">0</span>：只要本地配置的有对应地址，就给予回应；默认
<span class="m">1</span>：仅在请求的目的地址配置在到达的接口上时，才给予回应

<span class="c1"># arp_announce：定义将自己的地址向外通告时的通告级别</span>
<span class="m">0</span>：将本地任何接口上的任何地址向外通告；默认
<span class="m">1</span>：试图仅向目标网络通告其网络匹配的地址
<span class="m">2</span>：仅向与本地接口上地址匹配的网络进行通告

<span class="c1"># 单个实例必须相同的配置项</span>
vrrp_instance VI_1
virtual_router_id <span class="m">51</span>
auth_type PASS
auth_pass <span class="m">1111</span>
virtual_ipaddress

<span class="c1"># 单个实例必须不相同的配置项</span>
router_id id1
state MASTER  
priority <span class="m">100</span>

<span class="c1"># 上述简化设置--在realserver创建脚本rs.sh</span>
<span class="c1">#!/bin/bash</span>
<span class="c1">#适用于centos6</span>
<span class="nv">vip1</span><span class="o">=</span><span class="m">1</span>.1.1.10
<span class="nv">vip2</span><span class="o">=</span><span class="m">1</span>.1.1.20
<span class="nv">dev1</span><span class="o">=</span>lo:1
<span class="nv">dev2</span><span class="o">=</span>lo:2
<span class="k">case</span> <span class="nv">$1</span> in
start<span class="o">)</span>
    <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
    <span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
    <span class="nb">echo</span> <span class="m">2</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce
    <span class="nb">echo</span> <span class="m">2</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
    ifconfig <span class="nv">$dev1</span> <span class="nv">$vip1</span> netmask <span class="m">255</span>.255.255.255 broadcast <span class="nv">$vip</span> up
    ifconfig <span class="nv">$dev2</span> <span class="nv">$vip2</span> netmask <span class="m">255</span>.255.255.255 broadcast <span class="nv">$vip2</span> up
    sysctl -p &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
    <span class="nb">echo</span> <span class="s2">&quot;VS Server is Ready!&quot;</span>
    <span class="p">;;</span>
stop<span class="o">)</span>
    ifconfig <span class="nv">$dev</span> down
    <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
    <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
    <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce
    <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
    <span class="nb">echo</span> <span class="s2">&quot;VS Server is Cancel!&quot;</span>
    <span class="p">;;</span>
*<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage `basename </span><span class="nv">$0</span><span class="s2">` start|stop&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
    <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>

<h2 id="lvskeepalived_1">LVS服务器上分别安装并配置keepalived<a class="headerlink" href="#lvskeepalived_1" title="Permanent link">&para;</a></h2>
<h3 id="lvskeepalivedconf">主LVS配置keepalived.conf<a class="headerlink" href="#lvskeepalivedconf" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>global_defs <span class="o">{</span>
    notification_email <span class="o">{</span>
         your_email@qq.com   <span class="c1"># 邮件发生目的人</span>
       <span class="o">}</span>
    notification_email_from keepalived@localhost
    smtp_server <span class="m">127</span>.0.0.1 <span class="c1">#本机邮件服务器</span>
    smtp_connect_timeout <span class="m">30</span> <span class="c1">#超时时间</span>
    router_id LVS_R1  <span class="c1"># 标识服务器ID</span>
<span class="o">}</span>

vrrp_sync_group VG1 <span class="o">{</span>   <span class="c1"># 设置实例组</span>
    group <span class="o">{</span>
        VI_1
        VI_2
    <span class="o">}</span>
<span class="o">}</span>

vrrp_instance VI_1 <span class="o">{</span>    <span class="c1"># 实例名称，实例可以一个，也可多个</span>
state MASTER    <span class="c1"># 主LVS服务器</span>
interface eth0  <span class="c1"># 网卡接口</span>
virtual_router_id <span class="m">1</span> <span class="c1"># 服务器id</span>
priority <span class="m">100</span>    <span class="c1"># 优先级(0~255)</span>
advert_int <span class="m">1</span>    <span class="c1"># 心跳检测1秒每次</span>
authentication <span class="o">{</span>    <span class="c1"># 设置验证，master和backup必须相同</span>
    auth_type PASS  <span class="c1"># 基于密码验证类型</span>
    auth_pass <span class="m">1111</span>  <span class="c1"># 密码</span>
<span class="o">}</span>
virtual_ipaddress <span class="o">{</span>
    <span class="m">1</span>.1.1.1 <span class="c1"># 公网浮动IP</span>
 <span class="o">}</span>
<span class="o">}</span>
vrrp_instance VI_2 <span class="o">{</span>
state MASTER
interface eth1
virtual_router_id <span class="m">1</span>
priority <span class="m">100</span>
advert_int <span class="m">1</span>
authentication <span class="o">{</span>
    auth_type PASS
    auth_pass <span class="m">1111</span>
<span class="o">}</span>
virtual_ipaddress <span class="o">{</span>
    <span class="m">192</span>.168.1.1 <span class="c1"># 内网浮动IP</span>
 <span class="o">}</span>
<span class="o">}</span>
virtual_server <span class="m">1</span>.1.1.1 <span class="m">80</span> <span class="o">{</span>
delay_loop <span class="m">15</span>   <span class="c1"># 健康检查的时间</span>
lb_algo rr      <span class="c1"># 调度算法</span>
lb_kind NAT      <span class="c1"># 负载均衡群集的调度方式</span>
protocol TCP
    real_server <span class="m">192</span>.168.1.100 <span class="m">80</span> <span class="o">{</span>
        weight <span class="m">1</span>    <span class="c1"># 权重值</span>
        TCP_CHECK <span class="o">{</span> <span class="c1"># 健康检查方式</span>
            connect_port <span class="m">80</span>     <span class="c1"># 检查目标端口</span>
            connect_timeout <span class="m">3</span>   <span class="c1"># 链接超时时间</span>
            nb_get_retry <span class="m">3</span>      <span class="c1"># 重试次数</span>
            delay_before_retry <span class="m">4</span>  <span class="c1"># 重试间隔时间</span>
        <span class="o">}</span>
    <span class="o">}</span>
    real_server <span class="m">192</span>.168.1.200 <span class="m">80</span> <span class="o">{</span>
        weight <span class="m">1</span>
        TCP_CHECK <span class="o">{</span>
            connect_port <span class="m">80</span>
            connect_timeout <span class="m">3</span>
            nb_get_retry <span class="m">3</span>
            delay_before_retry <span class="m">4</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h3 id="lvs_1">从LVS配置<a class="headerlink" href="#lvs_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span>global_defs <span class="o">{</span>
router_id LVS_R1
<span class="o">}</span>

vrrp_sync_group VG1 <span class="o">{</span>
    group <span class="o">{</span>
        VI_1
        VI_2
    <span class="o">}</span>
<span class="o">}</span>

vrrp_instance VI_1 <span class="o">{</span>
state BACKUP
interface eth0
virtual_router_id <span class="m">1</span>
priority <span class="m">90</span>
advert_int <span class="m">1</span>
authentication <span class="o">{</span>
    auth_type PASS
    auth_pass <span class="m">1111</span>
<span class="o">}</span>
virtual_ipaddress <span class="o">{</span>
    <span class="m">1</span>.1.1.1
 <span class="o">}</span>
<span class="o">}</span>
vrrp_instance VI_2 <span class="o">{</span>
state BACKUP
interface eth1
virtual_router_id <span class="m">1</span>
priority <span class="m">90</span>
advert_int <span class="m">1</span>
authentication <span class="o">{</span>
    auth_type PASS
    auth_pass <span class="m">1111</span>
<span class="o">}</span>
virtual_ipaddress <span class="o">{</span>
    <span class="m">192</span>.168.1.1
 <span class="o">}</span>
<span class="o">}</span>
virtual_server <span class="m">1</span>.1.1.1 <span class="m">80</span> <span class="o">{</span>
delay_loop <span class="m">15</span>   <span class="c1"># 健康检查的时间</span>
lb_algo rr      <span class="c1"># 调度算法</span>
lb_kind NAT      <span class="c1"># 负载均衡群集的模式</span>
protocol TCP
    real_server <span class="m">192</span>.168.1.100 <span class="m">80</span> <span class="o">{</span>
        weight <span class="m">1</span>    <span class="c1"># 权重值</span>
        TCP_CHECK <span class="o">{</span>
            connect_port <span class="m">80</span>     <span class="c1"># 检查目标端口</span>
            connect_timeout <span class="m">3</span>   <span class="c1"># 链接超时时间</span>
            nb_get_retry <span class="m">3</span>      <span class="c1"># 重试次数</span>
            delay_before_retry <span class="m">4</span>  <span class="c1"># 重试间隔时间</span>
        <span class="o">}</span>
    <span class="o">}</span>
    real_server <span class="m">192</span>.168.1.200 <span class="m">80</span> <span class="o">{</span>
        weight <span class="m">1</span>
        TCP_CHECK <span class="o">{</span>
            connect_port <span class="m">80</span>
            connect_timeout <span class="m">3</span>
            nb_get_retry <span class="m">3</span>
            delay_before_retry <span class="m">4</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h2 id="lvs_notifysh">创建通用单独的检查邮件提醒脚本lvs_notify.sh<a class="headerlink" href="#lvs_notifysh" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">contact</span><span class="o">=</span><span class="s1">&#39;your_email_address&#39;</span>

notify<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local</span> <span class="nv">mailsubject</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2"> to be </span><span class="nv">$1</span><span class="s2">, vip floating&quot;</span>
    <span class="nb">local</span> <span class="nv">mailbody</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>date +<span class="s1">&#39;%F %T&#39;</span><span class="k">)</span><span class="s2">: vrrp transition, </span><span class="k">$(</span>hostname<span class="k">)</span><span class="s2"> changed to be </span><span class="nv">$1</span><span class="s2">&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$mailbody</span><span class="s2">&quot;</span> <span class="p">|</span> mail -s <span class="s2">&quot;</span><span class="nv">$mailsubject</span><span class="s2">&quot;</span> <span class="nv">$contact</span>
<span class="o">}</span>

<span class="k">case</span> <span class="nv">$1</span> in
master<span class="o">)</span>
    notify master
    <span class="p">;;</span>
backup<span class="o">)</span>
    notify backup
    <span class="p">;;</span>
fault<span class="o">)</span>
    notify fault
    <span class="p">;;</span>
*<span class="o">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;Usage: </span><span class="k">$(</span>basename <span class="nv">$0</span><span class="k">)</span><span class="s2"> {master|backup|fault}&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
    <span class="p">;;</span>
<span class="k">esac</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../TrafficServer/" title="ApacheTrafficServer" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                ApacheTrafficServer
              </span>
            </div>
          </a>
        
        
          <a href="../Haproxy/" title="HAProxy" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                HAProxy
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/Black-Gold" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://www.instagram.com/black0gold/" class="md-footer-social__link fa fa-instagram"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.245445c6.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../assets/javascripts/lunr/lunr.ja.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>